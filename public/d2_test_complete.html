<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D2 Aufmerksamkeitstest | AImpacts</title>
    <style>
        /*
         * ===== Modern Medical Theme Variables =====
         */
        :root {
          --primary: #0b6efd;         /* Calm diagnostic blue */
          --primary-dark: #0953c6;
          --accent: #198754;          /* subtle green accents */
          --danger: #d63384;          /* for incorrect/missed */
          --warning: #ffc107;
          --dark-text: #212529;
          --light-bg: #f5f7fa;
          --container-bg: #ffffff;
          --container-shadow: 0 8px 20px rgba(0,0,0,0.04);
          --radius: 8px;
        }

        /*
          * Global Styles and Utility Classes
         */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--light-bg);
            color: var(--dark-text);
            min-height: 100vh;
            padding: 24px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: var(--radius);
            box-shadow: var(--container-shadow);
            overflow: hidden;
        }

        /*
         * Header Section
         */
        .header {
            background: var(--container-bg);
            color: var(--primary);
            padding: 32px 24px;
            text-align: center;
            border-bottom: 4px solid var(--primary);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        /*
         * Setup Panel
         */
        .setup-panel {
            padding: 30px;
            background: #f8f9fa;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, select {
            width: 100%;
            max-width: 320px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-hint {
            font-size: 0.85em;
            color: #666;
            margin-top: 4px;
            max-width: 320px;
        }

        .form-row {
            display: flex;
            gap: 30px;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .form-column {
            flex: 1;
            min-width: 280px;
        }

        .general-info {
            background: #f0f8ff;
            border: 1px solid #d1e7ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9em;
            color: #555;
        }

        .form-group input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .instructions {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #2196F3;
        }

        .instructions h3 {
            color: #1976D2;
            margin-bottom: 10px;
        }

        .instructions ul {
            margin-left: 20px;
            list-style-type: disc;
        }

        .instructions li {
            margin-bottom: 5px;
        }

        /*
         * Buttons
         */
        .btn {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            margin: 8px;
            display: inline-block;
        }

        .btn:hover {
            background: var(--primary-dark);
            box-shadow: 0 4px 12px rgba(11,110,253,0.25);
        }

        .btn:disabled {
            background: #adb5bd;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .btn-secondary {
            background: #adb5bd;
            color: #333;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            margin: 8px;
            display: inline-block;
        }

        .btn-secondary:hover {
            background: #d2d6da;
            box-shadow: 0 4px 12px rgba(210,214,218,0.25);
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            margin: 8px;
            display: inline-block;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: 0 4px 12px rgba(11,110,253,0.25);
        }

        /*
         * Test Area
         */
        .test-area {
            padding: 30px;
            display: none;
        }

        .test-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .timer {
            font-size: 1.5em;
            font-weight: bold;
            color: #ff6b6b;
        }

        .progress {
            font-size: 1.2em;
            color: #4CAF50;
        }

        .input-method {
            font-size: 0.9em;
            color: #666;
            background: #fff;
            padding: 5px 10px;
            border-radius: 15px;
        }

        .test-row {
            margin-bottom: 15px;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .row-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .row-number {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }

        .row-timer {
            font-size: 0.9em;
            color: #666;
        }

        .symbols {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: flex-start;
            align-items: flex-start;
            line-height: 0;
        }

        .symbol {
            position: relative;
            cursor: pointer;
            padding: 8px 5px;
            border-radius: 6px;
            transition: all 0.2s;
            user-select: none;
            min-width: 40px;
            height: 3.5em;
            text-align: center;
            border: 1px solid #ddd;
            font-family: 'Courier New', monospace;
            font-size: 1.5em;
            display: inline-flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            line-height: 1.1;
            vertical-align: top;
        }

        .symbol .base-char {
            z-index: 1;
            position: relative;
            line-height: 1;
        }

        .symbol .stroke-top,
        .symbol .stroke-bottom {
            position: absolute;
            font-size: 0.6em;
            line-height: 0.8;
            white-space: nowrap;
            z-index: 2;
            color: #333;
        }

        .symbol .stroke-top {
            top: 0.1em;
            left: 50%;
            transform: translateX(-50%);
        }

        .symbol .stroke-bottom {
            bottom: 0.1em;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .symbol.selected {
            background: #4CAF50;
            color: white;
            border-color: #45a049;
        }

        .symbol.correct {
            background: #4CAF50;
            color: white;
        }

        .symbol.incorrect {
            background: #f44336;
            color: white;
        }

        .symbol.missed {
            background: #ff9800;
            color: white;
        }

        /* Practice test feedback animations */
        .symbol.correct {
            background: linear-gradient(45deg, #4CAF50, #388E3C) !important;
            color: white !important;
            border-color: #388E3C !important;
            animation: correctPulse 0.5s ease-in-out;
        }

        .symbol.incorrect {
            background: linear-gradient(45deg, #f44336, #d32f2f) !important;
            color: white !important;
            border-color: #d32f2f !important;
            animation: incorrectShake 0.5s ease-in-out;
        }

        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /*
         * Results Section
         */
        .results {
            display: none;
            padding: 30px;
            text-align: center;
        }

        .score-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }

        .score-item {
            text-align: center;
        }

        .score-value {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }

        .score-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .chart-container {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .data-management {
            margin-top: 30px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 10px;
            border-left: 5px solid #ffc107;
        }

        /*
         * Responsive Adjustments
         */
        @media (max-width: 768px) {
            .symbols {
                font-size: 1.2em;
                gap: 5px;
            }
            
            .symbol {
                min-width: 30px;
                padding: 6px;
                font-size: 1.2em;
                height: 3em;
            }
            
            .test-controls {
                flex-direction: column;
                gap: 10px;
            }

            .score-card {
                flex-direction: column;
                gap: 10px;
            }

            .score-item {
                margin: 0;
            }
        }

        /*
         * Instruction Cards
         */
        .instruction-card, .rules-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 5px solid #4CAF50;
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-header .icon {
            font-size: 1.5em;
            margin-right: 12px;
        }

        .card-header h4 {
            margin: 0;
            color: #333;
            font-size: 1.3em;
        }

        /*
         * Examples Section
         */
        .examples-section {
            margin: 30px 0;
        }

        .examples-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .example-group {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .example-group.correct {
            border-left: 5px solid #4CAF50;
        }

        .example-group.incorrect {
            border-left: 5px solid #f44336;
        }

        .example-group h5 {
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            font-size: 1.1em;
        }

        .example-group h5 .icon {
            margin-right: 8px;
            font-size: 1.2em;
        }

        .symbol-examples {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /*
         * Practice Section
         */
        .practice-section {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
            border-radius: 12px;
            padding: 25px;
            margin: 30px 0;
            border-left: 5px solid #2196F3;
        }

        .practice-symbols {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .practice-controls {
            text-align: center;
            margin: 20px 0;
        }

        .practice-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }

        .practice-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .practice-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /*
         * Button Variants
         */
        .btn-secondary {
            background: #6c757d;
        }

        .btn-primary {
            background: var(--primary);
        }

        .btn:disabled {
            background: #adb5bd;
            color: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /*
         * Responsive Examples
         */
        @media (max-width: 768px) {
            .examples-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .practice-symbols {
                gap: 10px;
            }
            
            .symbol-examples {
                gap: 8px;
            }
        }

        /*
         * Feedback Messages
         */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 5px solid #f44336;
        }

        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 5px solid #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div id="debugModeIndicator" style="display: none; background: #ff6b6b; color: white; padding: 8px; text-align: center; font-weight: bold; border-radius: 5px; margin-bottom: 10px;">
                üîß DEBUG MODE AKTIV
            </div>
            <h1>d2-Aufmerksamkeitstest</h1>
            <p>Konzentrations- und Aufmerksamkeitsmessung</p>
        </div>

        <div id="setupPanel" class="setup-panel">
            <div class="instructions">
                <h3>D2-Aufmerksamkeitstest: Anleitung</h3>
                
                <div class="instruction-card">
                    <div class="card-header">

                        <h4>Deine Aufgabe</h4>
                    </div>
                    <p>Markiere <strong>alle "d" mit genau 2 Strichen/Punkten</strong> (oben und/oder unten).</p>
                    <p>Ein Strich (‚Äî) entspricht 2 Punkten (..) ‚Ä¢ Kombinationen sind m√∂glich</p>
                    
                    <div class="examples-section">
                        <div class="examples-grid">
                            <div class="example-group correct">
                                <h5><span class="icon">‚úì</span> RICHTIG - Markiere diese:</h5>
                                <div class="symbol-examples" id="correctExamples"></div>
                            </div>
                            
                            <div class="example-group incorrect">
                                <h5><span class="icon">‚úó</span> FALSCH - Nicht markieren:</h5>
                                <div class="symbol-examples" id="incorrectExamples"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="practice-section" style="background: #e8f4fd; border: 2px solid #007bff; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px;">
                        <!-- Linke Seite: Titel und Beschreibung -->
                        <div style="flex: 1; min-width: 200px;">
                            <h4 style="color: #007bff; margin: 0 0 10px 0; font-size: 1.2em;">√úbung vorab - Probe vor dem echten Test</h4>
                            <p style="margin: 0 0 10px 0; font-size: 0.9em; color: #495057;">Teste dein Verst√§ndnis mit 7 Beispiel-Symbolen:</p>
                        </div>
                        
                        <!-- Rechte Seite: √úbungsbereich und Buttons -->
                        <div style="flex: 1; min-width: 300px;">
                            <div id="practiceArea" class="practice-symbols" style="margin-bottom: 10px; min-height: 60px; background: white; border-radius: 4px; padding: 10px;"></div>
                            <div class="practice-controls" style="display: flex; gap: 8px; justify-content: center;">
                                <button class="btn btn-secondary" onclick="generatePractice()" style="font-size: 0.85em; padding: 6px 12px;">üîÑ Neue √úbung</button>
                                <button class="btn btn-primary" onclick="checkPractice()" id="checkPracticeBtn" disabled style="font-size: 0.85em; padding: 6px 12px;">‚úÖ L√∂sung pr√ºfen</button>
                            </div>
                            <div id="practiceResult" class="practice-result" style="margin-top: 8px; font-size: 0.85em;"></div>
                        </div>
                    </div>
                </div>

                <div class="rules-card" style="background: #f8f9fa; border-radius: 6px; padding: 12px;">
                    <h4 style="color: #495057; margin: 0 0 8px 0; font-size: 1.1em;">Testregeln</h4>
                    <ul style="margin: 0; padding-left: 18px; font-size: 0.9em; line-height: 1.4;">
                        <li><strong>Geschwindigkeit:</strong> 20 Sekunden pro Zeile (14 Zeilen)</li>
                        <li><strong>Eingabe:</strong> Maus, Finger oder Stift</li>
                        <li><strong>Feedback:</strong> Markierte Zeichen werden gr√ºn hervorgehoben</li>
                        <li><strong>Ziel:</strong> So schnell und genau wie m√∂glich arbeiten</li>
                    </ul>
                </div>
            </div>

            <!-- Eingabefelder vor Test-Start -->
            <div class="form-row" style="margin: 20px 0;">
                <div class="form-column">
                    <div class="form-group">
                        <label for="userCode">Dein Code (z.B. Michael271274):</label>
                        <input type="text" id="userCode" placeholder="Name + Geburtsdatum">
                        <p class="input-hint">Verwende Name + Geburtsdatum als Code ‚Äì leicht merkbar und wiederverwendbar. Alle Angaben bleiben nur lokal in deinem Browser, lassen sich aber exportieren f√ºr andere Ger√§te.</p>
                    </div>
                </div>
                
                <div class="form-column">
                    <div class="form-group">
                        <label for="medication">Medikation:</label>
                        <select id="medication">
                            <option value="ohne">Ohne Medikation</option>
                            <option value="mit">Mit Medikation</option>
                        </select>
                        <p class="input-hint">W√§hle "Mit Medikation", um den Einfluss von Medikamenten auf deine Aufmerksamkeit zu verfolgen und zu vergleichen.</p>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <!-- Hauptaktionen -->
                <div style="margin-bottom: 15px;">
                    <button class="btn" onclick="startTest()" style="background: #28a745; color: white; font-weight: bold; padding: 12px 24px;" title="Starte einen neuen D2-Aufmerksamkeitstest">üöÄ Test starten</button>
                </div>
                
                <!-- Ergebnisse anzeigen -->
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn" onclick="showResults()" title="Zeige deine gespeicherten Testergebnisse an">üìä Meine Ergebnisse</button>
                </div>
            </div>
            
            <!-- Debug Mode Buttons (only visible when debug=1 URL parameter is set) -->
            <div id="debugButtons" style="display: none; margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 10px; border-left: 5px solid #ffc107;">
                <h4>üîß Debug-Modus (Entwickler)</h4>
                <p style="margin-bottom: 15px; color: #856404;">Funktionen f√ºr Entwicklung, Tests und Debugging:</p>
                
                <!-- Test-Simulation -->
                <div style="margin-bottom: 15px;">
                    <h5 style="color: #856404; margin-bottom: 8px;">üéØ Test-Simulation:</h5>
                    <button class="btn btn-secondary" onclick="runSingleRowTest()" style="background: #9C27B0; color: white;" title="F√ºhrt nur eine Testzeile aus - ideal zum Debuggen">üìù Schnelltest (1 Zeile)</button>
                    <button class="btn btn-secondary" onclick="createTestData()" style="background: #2196F3; color: white;" title="Erstellt Dummy-Testdaten zum Testen der Anzeige">üé≤ Dummy-Daten erstellen</button>
                </div>
                
                <!-- Datenanalyse -->
                <div style="margin-bottom: 15px;">
                    <h5 style="color: #856404; margin-bottom: 8px;">üìä Datenanalyse:</h5>
                    <button class="btn btn-secondary" onclick="showCookieData()" title="Zeigt alle Cookie-Daten in lesbarer Form">üç™ Cookie-Details anzeigen</button>
                    <button class="btn btn-secondary" onclick="showAllStorageData()" title="Zeigt alle Speicherdaten (Cookies + LocalStorage)">üìä Alle Speicherdaten</button>
                    <button class="btn btn-secondary" onclick="testStorage()" style="background: #ff9800; color: white;" title="Testet die Funktionsf√§higkeit von Cookies und LocalStorage">üß™ Speicher-Funktionstest</button>
                </div>
                
                <!-- Entwicklung -->
                <div>
                    <h5 style="color: #856404; margin-bottom: 8px;">üîß Entwicklung:</h5>
                    <button class="btn btn-secondary" onclick="deleteAllCookies()" style="background: #dc3545; color: white;" title="L√∂scht alle D2-Test Cookies und LocalStorage Daten">üóëÔ∏è Alle Cookies l√∂schen</button>
                    <button class="btn btn-secondary" onclick="clearAllDebugData()" style="background: #6c757d; color: white;" title="L√∂scht alle Debug- und Testdaten">üßπ Debug-Reset</button>
                </div>
            </div>
        </div>

        <div id="testArea" class="test-area">
            <div class="test-controls">
                <div class="timer">‚è±Ô∏è Zeit: <span id="timer">20</span>s</div>
                <div class="progress">üìä Zeile: <span id="currentRow">1</span>/14</div>
                <div class="input-method" id="inputMethod">üñ±Ô∏è Maus</div>
            </div>
            <div id="testContent"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="nextRow()" id="nextBtn" disabled>N√§chste Zeile</button>
                <button class="btn" onclick="finishTest()" id="finishBtn" style="display: none;">Test beenden</button>
            </div>
        </div>

        <div id="results" class="results">
            <h2>Testergebnisse</h2>
            <div id="scoreCard" class="score-card"></div>
            <div class="chart-container">
                <canvas id="progressChart" width="800" height="400"></canvas>
            </div>
            <div style="text-align: center;">
                <button class="btn" onclick="syncData()" title="Repariert deine Daten zwischen Cookies und LocalStorage">üîÑ Meine Daten reparieren</button>
                <button class="btn" onclick="createBackup()" style="background: #6f42c1; color: white;" title="Exportiert alle User-Daten als vollst√§ndiges System-Backup">üíæ Alle Daten exportieren</button>
                <button class="btn" onclick="runComprehensiveStorageTest()" title="Testet die Speicher-Funktionalit√§t des Systems">üß™ Speicher-Test</button>
            </div>

            <div class="data-management">
                <h3>üìä Datenverwaltung</h3>
                <p>Ihre Daten werden sicher in Cookies und LocalStorage des Browsers gespeichert und k√∂nnen zwischen Ger√§ten √ºbertragen werden.</p>
                
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #4CAF50;">
                    <h4 style="color: #2e7d32; margin-bottom: 10px;">üíæ Speicherorte:</h4>
                    <ul style="margin-left: 20px; color: #2e7d32;">
                        <li><strong>Browser-Daten:</strong> Automatisch im lokalen Speicher</li>
                        <li><strong>Export-Dateien:</strong> Downloads-Ordner Ihres Computers</li>
                        <li><strong>Backup-Dateien:</strong> Downloads-Ordner (d2-test-backup-YYYY-MM-DD.json)</li>
                        <li><strong>Einzelexport:</strong> Downloads-Ordner (d2-test-BENUTZERNAME-YYYY-MM-DD.json)</li>
                    </ul>
                    <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        üí° <strong>Tipp:</strong> Sichern Sie regelm√§√üig Ihre Daten mit der Export-Funktion, 
                        um sie zwischen verschiedenen Ger√§ten zu √ºbertragen oder als Backup zu verwenden.
                    </p>
                </div>
                
                <div id="dataStatus"></div>
                
                <!-- Hauptaktionen auf der Ergebnis-Seite -->
                <div style="margin-top: 20px; text-align: center;">
                    <div style="margin-bottom: 15px;">
                        <button class="btn" onclick="resetTest()" style="background: #28a745; color: white; font-weight: bold; padding: 12px 24px;" title="Zur√ºck zur Startseite">üè† Zur√ºck zur Startseite</button>
                    </div>
                    
                    <!-- Datenverwaltung -->
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: #495057; margin-bottom: 10px;">üìÅ Datenverwaltung</h4>
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button class="btn" onclick="saveCookieDataToFile()" style="background: #007bff; color: white;" title="Exportiere deine Testergebnisse als JSON-Datei">üíæ Meine Daten exportieren</button>
                            <button class="btn" onclick="importData()" title="Importiere Testergebnisse aus JSON-Datei">üìÅ Daten importieren</button>
                            <button class="btn" onclick="syncData()" title="Repariert deine Daten zwischen Cookies und LocalStorage">üîÑ Meine Daten reparieren</button>
                            <button class="btn" onclick="deleteDataWithConfirmation()" style="background: #dc3545; color: white;" title="L√∂sche deine Testergebnisse mit detaillierter Best√§tigung">üóëÔ∏è Meine Daten l√∂schen</button>
                        </div>
                    </div>
                </div>
                
                <!-- Debug-Funktionen (Ergebnis-Seite) -->
                <div id="debugButtonsResults" style="display: none; background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #ffc107;">
                    <h4 style="color: #856404; margin-bottom: 10px;">üîß Debug-Funktionen (Ergebnis-Seite)</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn" onclick="showCookieData()" style="background: #17a2b8; color: white;" title="Zeigt Cookie-Details f√ºr diese Ergebnis-Seite">üç™ Cookie-Details</button>
                        <button class="btn" onclick="showStorageInfo()" style="background: #6c757d; color: white;" title="Zeigt detaillierte Speicher-Informationen">‚ÑπÔ∏è Speicher-Info</button>
                        <button class="btn" onclick="testStorage()" style="background: #28a745; color: white;" title="Testet Speicher-Funktionalit√§t">üß™ Speicher-Test</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTest = {
            rows: [],
            currentRowIndex: 0,
            startTime: null,
            rowStartTime: null,
            results: [],
            userCode: '',
            medication: '',
            inputMethod: 'mouse',
            deviceInfo: getDeviceInfo()
        };

        let testData = [];
        let rowTimer = null;
        let testRunning = false;
        let practiceSymbols = [];
        let practiceSelections = [];

        // Check for debug mode
        function isDebugMode() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('debug') === '1';
        }

        // Initialize examples and practice on page load
        document.addEventListener('DOMContentLoaded', function() {
            generateExamples();
            generatePractice();
            currentTest.deviceInfo = getDeviceInfo();
            
            // Show debug buttons if debug mode is enabled
            console.log('üîç Checking debug mode...', window.location.search);
            if (isDebugMode()) {
                console.log('‚úÖ Debug mode detected!');
                
                // Show debug indicator in header
                const debugIndicator = document.getElementById('debugModeIndicator');
                if (debugIndicator) {
                    debugIndicator.style.display = 'block';
                }
                
                // Show debug buttons section
                const debugElement = document.getElementById('debugButtons');
                if (debugElement) {
                    debugElement.style.display = 'block';
                    console.log('üîß Debug-Modus aktiviert! Debug-Sektion angezeigt.');
                } else {
                    console.error('‚ùå Debug-Element nicht gefunden!');
                }
                
                // Also show debug buttons in results section
                const debugResultsElement = document.getElementById('debugButtonsResults');
                if (debugResultsElement) {
                    debugResultsElement.style.display = 'block';
                    console.log('üîß Debug-Buttons auch in Ergebnis-Sektion aktiviert.');
                }
            } else {
                console.log('‚ùå Debug mode NOT detected');
            }
            
            // Input method detection
            const deviceInfo = getDeviceInfo();
            let initialMethod = 'üñ±Ô∏è Maus';
            
            if (deviceInfo.isMobile) {
                initialMethod = 'üëÜ Finger';
                currentTest.inputMethod = 'finger';
            } else if (deviceInfo.isTablet) {
                initialMethod = '‚úèÔ∏è Stift/Finger';
                currentTest.inputMethod = 'stylus/finger';
            }
            
            document.getElementById('inputMethod').innerHTML = initialMethod;
            
            document.addEventListener('touchstart', function() {
                currentTest.inputMethod = deviceInfo.isTablet ? 'stylus/finger' : 'finger';
                document.getElementById('inputMethod').innerHTML = deviceInfo.isTablet ? '‚úèÔ∏è Stift/Finger' : 'üëÜ Finger';
            }, { passive: true });
            
            document.addEventListener('mousedown', function(e) {
                if (!e.sourceCapabilities || e.sourceCapabilities.firesTouchEvents === false) {
                    currentTest.inputMethod = 'mouse';
                    document.getElementById('inputMethod').innerHTML = 'üñ±Ô∏è Maus';
                }
            });
            
            if (window.PointerEvent) {
                document.addEventListener('pointerdown', function(e) {
                    if (e.pointerType === 'pen') {
                        currentTest.inputMethod = 'stylus';
                        document.getElementById('inputMethod').innerHTML = '‚úèÔ∏è Stift';
                    }
                });
            }
        });

        // Device and input detection
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            const isMobile = /iPhone|iPad|iPod|Android/i.test(ua);
            const isTablet = /iPad/i.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            
            return {
                isMobile: isMobile,
                isTablet: isTablet,
                isDesktop: !isMobile && !isTablet,
                userAgent: ua,
                touchSupport: 'ontouchstart' in window,
                platform: navigator.platform
            };
        }

        function detectInputMethod(event) {
            if (event.type.includes('touch')) {
                currentTest.inputMethod = currentTest.deviceInfo.isTablet ? 'stylus/finger' : 'finger';
                document.getElementById('inputMethod').innerHTML = currentTest.deviceInfo.isTablet ? '‚úèÔ∏è Stift/Finger' : 'üëÜ Finger';
            } else if (event.type.includes('mouse')) {
                currentTest.inputMethod = 'mouse';
                document.getElementById('inputMethod').innerHTML = 'üñ±Ô∏è Maus';
            }
        }

        // Symbol generation and rendering logic
        function getRandomStrokeConfig(forTarget = false, targetValue = null) {
            const options = [
                { type: 'none', value: 0, char: '' },
                { type: 'dot', value: 1, char: '.' },
                { type: 'double_dot', value: 2, char: '..' },
                { type: 'bar', value: 2, char: '‚Äî' }
            ];

            if (forTarget && targetValue !== null) {
                const targetOptions = options.filter(opt => opt.value === targetValue);
                if (targetValue === 0) return options[0];
                if (targetValue === 1 && targetOptions.length === 0) return options.find(o => o.type === 'dot');
                
                if (targetOptions.length > 0) {
                    return targetOptions[Math.floor(Math.random() * targetOptions.length)];
                } else {
                    console.warn(`No suitable stroke config for target value ${targetValue}. Defaulting to none.`);
                    return options[0];
                }
            } else {
                return options[Math.floor(Math.random() * options.length)];
            }
        }

        function calculateEffectiveStrokes(topConfig, bottomConfig) {
            return topConfig.value + bottomConfig.value;
        }

        function generateSymbols(count = 47, minTargets = 3) {
            const symbols = [];
            const baseSymbols = ['d', 'b'];

            const targetCombinations = [
                { top: 2, bottom: 0 }, 
                { top: 0, bottom: 2 }, 
                { top: 1, bottom: 1 }  
            ];

            for (let i = 0; i < count; i++) {
                const base = baseSymbols[Math.floor(Math.random() * baseSymbols.length)];
                
                let topStrokeConfig, bottomStrokeConfig;
                let effectiveStrokes;
                let isTarget = false;

                topStrokeConfig = getRandomStrokeConfig();
                bottomStrokeConfig = getRandomStrokeConfig();
                effectiveStrokes = calculateEffectiveStrokes(topStrokeConfig, bottomStrokeConfig);
                isTarget = (base === 'd' && effectiveStrokes === 2);

                symbols.push({
                    base: base,
                    topStrokes: topStrokeConfig,
                    bottomStrokes: bottomStrokeConfig,
                    effectiveStrokes: effectiveStrokes,
                    isTarget: isTarget,
                    id: i
                });
            }

            let actualTargetsCount = symbols.filter(s => s.isTarget).length;
            while (actualTargetsCount < minTargets) {
                const nonTargetDs = symbols.filter(s => s.base === 'd' && !s.isTarget);
                if (nonTargetDs.length === 0) {
                    console.warn("Could not meet minimum target count for row (no more convertible 'd's).");
                    break;
                }

                const symbolToConvert = nonTargetDs[Math.floor(Math.random() * nonTargetDs.length)];
                
                const combo = targetCombinations[Math.floor(Math.random() * targetCombinations.length)];
                symbolToConvert.topStrokes = getRandomStrokeConfig(true, combo.top);
                symbolToConvert.bottomStrokes = getRandomStrokeConfig(true, combo.bottom);
                symbolToConvert.effectiveStrokes = calculateEffectiveStrokes(symbolToConvert.topStrokes, symbolToConvert.bottomStrokes);
                symbolToConvert.isTarget = true;
                actualTargetsCount++;
            }
            
            return symbols;
        }

        function renderSymbol(symbol) {
            const topStrokeHTML = symbol.topStrokes.char ? `<span class="stroke-top">${symbol.topStrokes.char}</span>` : '';
            const bottomStrokeHTML = symbol.bottomStrokes.char ? `<span class="stroke-bottom">${symbol.bottomStrokes.char}</span>` : '';
            
            return `
                <div class="symbol" data-id="${symbol.id}" onclick="selectSymbol(${symbol.id})" 
                    onmousedown="detectInputMethod(event)" ontouchstart="detectInputMethod(event)">
                    ${topStrokeHTML}
                    <span class="base-char">${symbol.base}</span>
                    ${bottomStrokeHTML}
                </div>
            `;
        }

        // Examples and Practice Functions
        function generateExamples() {
            // Correct examples (all d with exactly 2 strokes/points)
            const correctExamples = [
                { base: 'd', topStrokes: { char: '‚Äî', value: 2 }, bottomStrokes: { char: '', value: 0 }, isTarget: true, id: 'ex1' },
                { base: 'd', topStrokes: { char: '', value: 0 }, bottomStrokes: { char: '‚Äî', value: 2 }, isTarget: true, id: 'ex2' },
                { base: 'd', topStrokes: { char: '.', value: 1 }, bottomStrokes: { char: '.', value: 1 }, isTarget: true, id: 'ex3' },
                { base: 'd', topStrokes: { char: '..', value: 2 }, bottomStrokes: { char: '', value: 0 }, isTarget: true, id: 'ex4' }
            ];

            // Incorrect examples
            const incorrectExamples = [
                { base: 'b', topStrokes: { char: '', value: 0 }, bottomStrokes: { char: '', value: 0 }, isTarget: false, id: 'ex5' },
                { base: 'd', topStrokes: { char: '', value: 0 }, bottomStrokes: { char: '', value: 0 }, isTarget: false, id: 'ex6' },
                { base: 'd', topStrokes: { char: '.', value: 1 }, bottomStrokes: { char: '', value: 0 }, isTarget: false, id: 'ex7' },
                { base: 'd', topStrokes: { char: '‚Äî', value: 2 }, bottomStrokes: { char: '‚Äî', value: 2 }, isTarget: false, id: 'ex8' }
            ];

            document.getElementById('correctExamples').innerHTML = 
                correctExamples.map(symbol => renderExampleSymbol(symbol, true)).join('');
            
            document.getElementById('incorrectExamples').innerHTML = 
                incorrectExamples.map(symbol => renderExampleSymbol(symbol, false)).join('');
        }

        function renderExampleSymbol(symbol, isCorrect) {
            const topStrokeHTML = symbol.topStrokes.char ? `<span class="stroke-top">${symbol.topStrokes.char}</span>` : '';
            const bottomStrokeHTML = symbol.bottomStrokes.char ? `<span class="stroke-bottom">${symbol.bottomStrokes.char}</span>` : '';
            const bgColor = isCorrect ? '#4CAF50' : '#f44336';
            
            return `
                <div class="symbol" style="background: ${bgColor}; color: white; border-color: ${bgColor};">
                    ${topStrokeHTML}
                    <span class="base-char">${symbol.base}</span>
                    ${bottomStrokeHTML}
                </div>
            `;
        }

        function generatePractice() {
            practiceSymbols = [];
            practiceSelections = [];
            
            // Definiere die 4 Pflicht-Symbole (genau einmal)
            const requiredConfigs = [
                // 3 richtige Targets (d mit genau 2 effektiven Strichen)
                { base: 'd', topValue: 1, bottomValue: 1, description: 'd mit 1 Punkt oben + 1 Punkt unten' },
                { base: 'd', topValue: 2, bottomValue: 0, description: 'd mit 2 Punkten oben' },
                { base: 'd', topValue: 0, bottomValue: 2, description: 'd mit 1 Strich unten' },
                // 1 falsches Symbol (d mit 4 effektiven Strichen)
                { base: 'd', topValue: 2, bottomValue: 2, description: 'd mit 1 Strich oben + 1 Strich unten (FALSCH)' }
            ];
            
            // 3 zus√§tzliche zuf√§llige Symbole
            const additionalConfigs = [
                { base: 'b', topValue: 0, bottomValue: 0, description: 'b ohne Striche' },
                { base: 'd', topValue: 0, bottomValue: 0, description: 'd ohne Striche' },
                { base: 'd', topValue: 1, bottomValue: 0, description: 'd mit 1 Punkt oben' }
            ];
            
            // Kombiniere alle Konfigurationen
            const allConfigs = [...requiredConfigs, ...additionalConfigs];
            
            // Mische die Reihenfolge
            for (let i = allConfigs.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allConfigs[i], allConfigs[j]] = [allConfigs[j], allConfigs[i]];
            }

            allConfigs.forEach((config, index) => {
                const topConfig = getRandomStrokeConfig(true, config.topValue);
                const bottomConfig = getRandomStrokeConfig(true, config.bottomValue);
                
                // Berechne effektive Striche wie im Test
                const effectiveStrokes = calculateEffectiveStrokes(topConfig, bottomConfig);
                const isTarget = (config.base === 'd' && effectiveStrokes === 2);
                
                practiceSymbols.push({
                    base: config.base,
                    topStrokes: topConfig,
                    bottomStrokes: bottomConfig,
                    effectiveStrokes: effectiveStrokes,
                    isTarget: isTarget,
                    id: index,
                    selected: false,
                    description: config.description
                });
                practiceSelections.push(false);
            });

            renderPractice();
        }

        function renderPractice() {
            const practiceHtml = practiceSymbols.map((symbol, index) => {
                const topStrokeHTML = symbol.topStrokes.char ? `<span class="stroke-top">${symbol.topStrokes.char}</span>` : '';
                const bottomStrokeHTML = symbol.bottomStrokes.char ? `<span class="stroke-bottom">${symbol.bottomStrokes.char}</span>` : '';
                const selectedClass = practiceSelections[index] ? 'selected' : '';
                
                return `
                    <div class="symbol ${selectedClass}" onclick="togglePracticeSymbol(${index})">
                        ${topStrokeHTML}
                        <span class="base-char">${symbol.base}</span>
                        ${bottomStrokeHTML}
                    </div>
                `;
            }).join('');

            document.getElementById('practiceArea').innerHTML = practiceHtml;
            document.getElementById('checkPracticeBtn').disabled = false;
            document.getElementById('practiceResult').innerHTML = '';
            document.getElementById('practiceResult').className = 'practice-result';
        }

        function togglePracticeSymbol(index) {
            practiceSelections[index] = !practiceSelections[index];
            const symbolElement = document.getElementById('practiceArea').children[index];
            
            if (practiceSelections[index]) {
                symbolElement.classList.add('selected');
            } else {
                symbolElement.classList.remove('selected');
            }
        }

        function checkPractice() {
            let correct = 0;
            let total = practiceSymbols.length;
            let errors = [];

            practiceSymbols.forEach((symbol, index) => {
                const shouldBeSelected = symbol.isTarget;
                const wasSelected = practiceSelections[index];
                
                if (shouldBeSelected === wasSelected) {
                    correct++;
                } else {
                    if (shouldBeSelected && !wasSelected) {
                        errors.push(`Symbol ${index + 1}: Sollte markiert werden (${symbol.base} mit ${symbol.topStrokes.value + symbol.bottomStrokes.value} Strichen)`);
                    } else {
                        errors.push(`Symbol ${index + 1}: Sollte NICHT markiert werden (${symbol.base} mit ${symbol.topStrokes.value + symbol.bottomStrokes.value} Strichen)`);
                    }
                }
            });

            const resultDiv = document.getElementById('practiceResult');
            
            if (correct === total) {
                resultDiv.className = 'practice-result success';
                resultDiv.innerHTML = `Perfekt! ${correct}/${total} richtig. Du hast das Prinzip verstanden!`;
            } else {
                resultDiv.className = 'practice-result error';
                resultDiv.innerHTML = `
                    ‚ùå ${correct}/${total} richtig. Bitte beachte:<br>
                    <small>${errors.join('<br>')}</small><br><br>
                    <strong>Merksatz:</strong> Nur "d" mit genau 2 Strichen/Punkten markieren!
                `;
            }

            // Show correct answers visually
            practiceSymbols.forEach((symbol, index) => {
                const symbolElement = document.getElementById('practiceArea').children[index];
                symbolElement.classList.remove('selected');
                
                if (symbol.isTarget) {
                    symbolElement.classList.add('correct');
                } else if (practiceSelections[index]) {
                    symbolElement.classList.add('incorrect');
                }
            });

            document.getElementById('checkPracticeBtn').disabled = true;
        }

        function generateTestRows() {
            const rows = [];
            for (let i = 0; i < 14; i++) {
                rows.push(generateSymbols(47));
            }
            return rows;
        }

        function startTest() {
            const userCode = document.getElementById('userCode').value.trim();
            if (!userCode) {
                alert('Bitte geben Sie Ihren Code ein!');
                return;
            }

            currentTest.userCode = userCode;
            currentTest.medication = document.getElementById('medication').value;
            currentTest.rows = generateTestRows();
            currentTest.startTime = new Date();
            currentTest.results = [];
            currentTest.currentRowIndex = 0;
            testRunning = true;

            // Defensive null checks for DOM elements
            const setupPanel = document.getElementById('setupPanel');
            const testArea = document.getElementById('testArea');
            
            if (!setupPanel) {
                console.error('‚ùå setupPanel element not found!');
                alert('Fehler: Setup-Panel nicht gefunden. Seite neu laden.');
                return;
            }
            
            if (!testArea) {
                console.error('‚ùå testArea element not found!');
                alert('Fehler: Test-Bereich nicht gefunden. Seite neu laden.');
                return;
            }

            setupPanel.style.display = 'none';
            testArea.style.display = 'block';
            
            renderCurrentRow();
            startRowTimer();
        }

        function renderCurrentRow() {
            const row = currentTest.rows[currentTest.currentRowIndex];
            const rowNumber = currentTest.currentRowIndex + 1;
            
            const symbolsHtml = row.map(symbol => renderSymbol(symbol)).join('');
            
            // Defensive null checks for DOM elements
            const testContent = document.getElementById('testContent');
            const currentRowEl = document.getElementById('currentRow');
            const nextBtn = document.getElementById('nextBtn');
            const finishBtn = document.getElementById('finishBtn');
            
            if (!testContent) {
                console.error('‚ùå testContent element not found!');
                const error = new Error('Cannot read properties of null (reading \'style\')');
                console.error('Error in renderCurrentRow:', error);
                return;
            }
            
            testContent.innerHTML = `
                <div class="test-row">
                    <div class="row-header">
                        <span class="row-number">Zeile ${rowNumber}</span>
                        <span class="row-timer" id="rowTimer">Zeit: 20s</span>
                    </div>
                    <div class="symbols">${symbolsHtml}</div>
                </div>
            `;
            
            if (currentRowEl) {
                currentRowEl.textContent = rowNumber;
            } else {
                console.warn('‚ö†Ô∏è currentRow element not found, but continuing...');
            }
            
            if (nextBtn) {
                nextBtn.disabled = false;
                
                if (currentTest.currentRowIndex === currentTest.rows.length - 1) {
                    nextBtn.style.display = 'none';
                    if (finishBtn) {
                        finishBtn.style.display = 'inline-block';
                    }
                } else {
                    nextBtn.style.display = 'inline-block';
                    if (finishBtn) {
                        finishBtn.style.display = 'none';
                    }
                }
            } else {
                console.error('‚ùå nextBtn element not found!');
            }

            document.querySelectorAll('.symbol').forEach((symbolEl, idx) => {
                symbolEl.setAttribute('role', 'button');
                symbolEl.setAttribute('aria-label', `Symbol ${idx + 1} (${symbolEl.textContent.trim()})`);
                symbolEl.setAttribute('tabindex', '0');
            });
        }

        function selectSymbol(symbolId) {
            if (!testRunning) return;
            
            const symbol = currentTest.rows[currentTest.currentRowIndex][symbolId];
            const symbolElement = document.querySelector(`[data-id="${symbolId}"]`);
            
            if (!symbolElement) {
                console.error('Symbol element not found for ID:', symbolId);
                return;
            }

            if (symbol.selected) {
                symbol.selected = false;
                symbolElement.classList.remove('selected');
            } else {
                symbol.selected = true;
                symbolElement.classList.add('selected');
            }
        }

        function startRowTimer() {
            currentTest.rowStartTime = new Date();
            let timeLeft = 20;
            document.getElementById('timer').textContent = timeLeft;
            
            rowTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;
                document.getElementById('rowTimer').textContent = `Zeit: ${timeLeft}s`;
                
                if (timeLeft <= 0) {
                    clearInterval(rowTimer);
                    nextRow();
                }
            }, 1000);
        }

        function nextRow() {
            if (!testRunning) return;
            
            clearInterval(rowTimer);
            
            const row = currentTest.rows[currentTest.currentRowIndex];
            const rowResult = calculateRowResult(row);
            currentTest.results.push(rowResult);
            
            showRowFeedback(row);
            
            setTimeout(() => {
                currentTest.currentRowIndex++;
                
                // Debug: Single row test - finish after first row
                if (window.debugSingleRow) {
                    console.log('üîß Debug: Single row test completed, finishing...');
                    finishTest();
                    window.debugSingleRow = false; // Reset flag
                    return;
                }
                
                if (currentTest.currentRowIndex < currentTest.rows.length) {
                    renderCurrentRow();
                    startRowTimer();
                } else {
                    finishTest();
                }
            }, 2000);
        }

        function calculateRowResult(row) {
            let correct = 0;
            let incorrect = 0;
            let missed = 0;
            let totalTargets = 0;
            
            row.forEach(symbol => {
                if (symbol.isTarget) {
                    totalTargets++;
                    if (symbol.selected) {
                        correct++;
                    } else {
                        missed++;
                    }
                } else if (symbol.selected) {
                    incorrect++;
                }
            });
            
            const timeSpent = (new Date() - currentTest.rowStartTime) / 1000;
            
            return {
                rowNumber: currentTest.currentRowIndex + 1,
                correct: correct,
                incorrect: incorrect,
                missed: missed,
                totalTargets: totalTargets,
                timeSpent: Math.round(timeSpent),
                processed: correct + incorrect,
                accuracy: totalTargets > 0 ? (correct / totalTargets * 100).toFixed(1) : 0
            };
        }

        function showRowFeedback(row) {
            row.forEach((symbol, index) => {
                const element = document.querySelector(`[data-id="${index}"]`);
                if (element) {
                    if (symbol.isTarget && symbol.selected) {
                        element.classList.add('correct');
                    } else if (symbol.isTarget && !symbol.selected) {
                        element.classList.add('missed');
                    } else if (!symbol.isTarget && symbol.selected) {
                        element.classList.add('incorrect');
                    }
                }
            });
            
            document.getElementById('nextBtn').disabled = true;
        }

        function finishTest() {
            testRunning = false;
            clearInterval(rowTimer);
            
            const totalResult = calculateTotalResult();
            
            console.log('=== SAVING TEST RESULT ===');
            console.log('Result to save:', totalResult);
            
            saveTestResult(totalResult);
            
            // Defensive null checks for DOM elements
            const testArea = document.getElementById('testArea');
            const results = document.getElementById('results');
            
            if (testArea) {
                testArea.style.display = 'none';
            } else {
                console.error('‚ùå testArea element not found in finishTest!');
            }
            
            if (results) {
                results.style.display = 'block';
            } else {
                console.error('‚ùå results element not found in finishTest!');
            }
            
            // Show debug buttons in results if debug mode is active
            if (isDebugMode()) {
                const debugResultsElement = document.getElementById('debugButtonsResults');
                if (debugResultsElement) {
                    debugResultsElement.style.display = 'block';
                }
            }
            
            displayResults(totalResult);
        }

        function calculateTotalResult() {
            const totalCorrect = currentTest.results.reduce((sum, row) => sum + row.correct, 0);
            const totalIncorrect = currentTest.results.reduce((sum, row) => sum + row.incorrect, 0);
            const totalMissed = currentTest.results.reduce((sum, row) => sum + row.missed, 0);
            const totalTargets = currentTest.results.reduce((sum, row) => sum + row.totalTargets, 0);
            const totalProcessed = currentTest.results.reduce((sum, row) => sum + row.processed, 0);
            const totalTime = (new Date() - currentTest.startTime) / 1000;
            
            const overallAccuracy = totalTargets > 0 ? (totalCorrect / totalTargets * 100).toFixed(1) : 0;
            const processingSpeed = (totalProcessed / (totalTime / 60)).toFixed(1);
            
            return {
                timestamp: currentTest.startTime ? currentTest.startTime.toISOString() : new Date().toISOString(),
                userCode: currentTest.userCode,
                medication: currentTest.medication,
                inputMethod: currentTest.inputMethod,
                deviceInfo: currentTest.deviceInfo,
                totalCorrect: totalCorrect,
                totalIncorrect: totalIncorrect,
                totalMissed: totalMissed,
                totalTargets: totalTargets,
                totalProcessed: totalProcessed,
                totalTime: Math.round(totalTime),
                overallAccuracy: parseFloat(overallAccuracy),
                processingSpeed: parseFloat(processingSpeed),
                rowResults: currentTest.results,
                concentrationIndex: calculateConcentrationIndex(),
                errorRate: totalProcessed > 0 ? (totalIncorrect / totalProcessed * 100).toFixed(1) : 0
            };
        }

        function calculateConcentrationIndex() {
            const totalCorrect = currentTest.results.reduce((sum, row) => sum + row.correct, 0);
            const totalIncorrect = currentTest.results.reduce((sum, row) => sum + row.incorrect, 0);
            return totalCorrect - totalIncorrect;
        }

        function saveTestResult(result) {
            console.log('=== SAVETESTRESULT CALLED ===');
            console.log('Saving result for user:', result.userCode);
            
            let saveSuccess = false;
            
            try {
                let localData = JSON.parse(localStorage.getItem('d2TestData') || '[]');
                console.log('Current localStorage data:', localData.length, 'entries');
                
                localData.push(result);
                localStorage.setItem('d2TestData', JSON.stringify(localData));
                
                console.log('‚úÖ LocalStorage saved successfully. New total:', localData.length);
                saveSuccess = true;
            } catch (e) {
                console.error('‚ùå LocalStorage save failed:', e);
            }
            
            try {
                const cookieName = `d2_${result.userCode}`;
                let cookieData = getCookieData(cookieName);
                cookieData.push(result);
                
                if (cookieData.length > 5) {
                    cookieData = cookieData.slice(-5);
                }
                
                const cookieValue = JSON.stringify(cookieData);
                const expiryDate = new Date();
                expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                
                document.cookie = `${cookieName}=${encodeURIComponent(cookieValue)}; expires=${expiryDate.toUTCString()}; path=/; SameSite=Lax`;
                
                console.log('‚úÖ Cookie saved successfully for:', result.userCode);
                saveSuccess = true;
            } catch (e) {
                console.error('‚ùå Cookie save failed:', e);
            }
            
            const statusDiv = document.getElementById('dataStatus');
            if (statusDiv) {
                if (saveSuccess) {
                    statusDiv.innerHTML = `
                        <div class="success">‚úÖ Testergebnis erfolgreich gespeichert!<br>
                        Code: ${result.userCode}<br>
                        Medikation: ${result.medication}<br>
                        Genauigkeit: ${result.overallAccuracy}%</div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="error">‚ùå Speichern fehlgeschlagen! Bitte versuche es erneut.</div>
                    `;
                }
            }
            
            console.log('=== SAVE COMPLETE ===');
            return saveSuccess;
        }

        function getCookieData(cookieName) {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === cookieName && value) {
                    try {
                        const decoded = decodeURIComponent(value);
                        return JSON.parse(decoded);
                    } catch (e) {
                        console.error('Cookie parsing failed for', cookieName, ':', e);
                        return [];
                    }
                }
            }
            return [];
        }

        function loadFromCookies(userCode) {
            const cookieName = `d2_${userCode}`;
            const data = getCookieData(cookieName);
            console.log('Loaded from cookies for', userCode, ':', data.length, 'results');
            return data;
        }

        function displayResults(result) {
    // Defensive handling of potentially missing values
    const totalCorrect = result.totalCorrect || 0;
    const totalIncorrect = result.totalIncorrect || 0;
    const overallAccuracy = result.overallAccuracy || 0;
    const processingSpeed = result.processingSpeed || 0;
    const concentrationIndex = result.concentrationIndex !== undefined ? result.concentrationIndex : (totalCorrect - totalIncorrect);
    const inputMethod = result.inputMethod || 'unbekannt';
    const errorRate = result.errorRate || 0;
    const totalProcessed = result.totalProcessed || 0;
    const totalTime = result.totalTime || 0;
    
    // Format timestamp properly
    const testDate = result.timestamp ? new Date(result.timestamp) : new Date();
    const dateStr = testDate.toLocaleDateString('de-DE', {
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit'
    });
    const timeStr = testDate.toLocaleTimeString('de-DE', {
        hour: '2-digit', 
        minute: '2-digit'
    });
    
    document.getElementById('scoreCard').innerHTML = `
        <div class="score-item">
            <span class="score-value">${totalCorrect}</span>
            <span class="score-label">Richtige Treffer</span>
        </div>
        <div class="score-item">
            <span class="score-value">${totalIncorrect}</span>
            <span class="score-label">Fehler</span>
        </div>
        <div class="score-item">
            <span class="score-value">${overallAccuracy.toFixed(1)}%</span>
            <span class="score-label">Genauigkeit</span>
        </div>
        <div class="score-item">
            <span class="score-value">${processingSpeed.toFixed(1)}</span>
            <span class="score-label">Items/Min</span>
        </div>
        <div class="score-item">
            <span class="score-value">${concentrationIndex}</span>
            <span class="score-label">Aufmerksamkeits-Index</span>
        </div>
        <div class="score-item">
            <span class="score-value">${errorRate}%</span>
            <span class="score-label">Fehlerrate</span>
        </div>
        <div class="score-item">
            <span class="score-value">${totalProcessed}</span>
            <span class="score-label">Bearbeitete Items</span>
        </div>
        <div class="score-item">
            <span class="score-value">${Math.round(totalTime/1000)}s</span>
            <span class="score-label">Testdauer</span>
        </div>
        <div class="score-item">
            <span class="score-value">${inputMethod}</span>
            <span class="score-label">Eingabemethode</span>
        </div>
        <div class="score-item">
            <span class="score-value">${dateStr}</span>
            <span class="score-label">Testdatum</span>
        </div>
        <div class="score-item">
            <span class="score-value">${timeStr}</span>
            <span class="score-label">Uhrzeit</span>
        </div>
    `;
    
    drawProgressChart(result);
}

        function displayEmptyResults(userCode) {
            // Show empty state in the score card area
            document.getElementById('scoreCard').innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <h3 style="color: #666; margin-bottom: 20px;">üì≠ Keine Daten vorhanden</h3>
                    <p style="color: #888; margin-bottom: 30px;">F√ºr den Code "${userCode}" wurden noch keine Testergebnisse gefunden.</p>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn" onclick="goToSetup()" style="background: #28a745; color: white; padding: 12px 24px;">
                            üöÄ Ersten Test starten
                        </button>
                        <button class="btn" onclick="importData()" style="background: #007bff; color: white; padding: 12px 24px;">
                            üìÅ Daten importieren
                        </button>
                    </div>
                </div>
            `;
            
            // Clear the chart area
            const chartContainer = document.getElementById('chartContainer');
            if (chartContainer) {
                chartContainer.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">Keine Daten zum Anzeigen</p>';
            }
        }

        function goToSetup() {
            // Hide results and show setup panel
            const setupPanel = document.getElementById('setupPanel');
            const results = document.getElementById('results');
            
            if (setupPanel) {
                setupPanel.style.display = 'block';
            }
            if (results) {
                results.style.display = 'none';
            }
        }

        function drawProgressChart(result) {
            const canvas = document.getElementById('progressChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const margin = 60;
            const chartWidth = canvas.width - 2 * margin;
            const chartHeight = canvas.height - 2 * margin;
            
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, margin + chartHeight);
            ctx.lineTo(margin + chartWidth, margin + chartHeight);
            ctx.stroke();
            
            ctx.fillStyle = '#333';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Leistung pro Zeile', canvas.width / 2, 30);
            
            const maxAccuracy = 100;
            const rowWidth = chartWidth / result.rowResults.length;
            
            result.rowResults.forEach((row, i) => {
                const x = margin + i * rowWidth + rowWidth / 2;
                const accuracy = parseFloat(row.accuracy);
                const barHeight = (accuracy / maxAccuracy) * chartHeight;
                const y = margin + chartHeight - barHeight;
                
                ctx.fillStyle = accuracy >= 80 ? '#4CAF50' : accuracy >= 60 ? '#ff9800' : '#f44336';
                ctx.fillRect(x - rowWidth / 3, y, rowWidth * 2/3, barHeight);
                
                ctx.fillStyle = '#333';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${accuracy}%`, x, y - 5);
                
                ctx.fillText(`${i + 1}`, x, margin + chartHeight + 15);
            });
            
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('Zeile', margin, margin + chartHeight + 35);
            ctx.textAlign = 'center';
            ctx.fillText('Genauigkeit (%)', margin - 35, margin + chartHeight / 2);
        }

        function showResults() {
            const userCode = document.getElementById('userCode').value.trim();
            if (!userCode) {
                alert('Bitte geben Sie Ihren Code ein!');
                return;
            }
            
            console.log('=== LOADING RESULTS FOR:', userCode, '===');
            
            let localData = [];
            try {
                localData = JSON.parse(localStorage.getItem('d2TestData') || '[]');
                console.log('Loaded from localStorage:', localData.length, 'total entries');
            } catch (e) {
                console.error('LocalStorage load failed:', e);
            }
            
            let cookieData = [];
            try {
                cookieData = loadFromCookies(userCode);
                console.log('Loaded from cookies:', cookieData.length, 'entries for user');
            } catch (e) {
                console.error('Cookie load failed:', e);
            }
            
            const allData = [...localData, ...cookieData];
            const userData = allData
                .filter(result => result.userCode === userCode)
                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
                .filter((item, index, arr) => 
                    index === arr.findIndex(t => t.timestamp === item.timestamp)
                );
            
            console.log('Final filtered data for user:', userData.length, 'entries');
            
            let hasData = userData.length > 0;
            
            // Defensive null checks for DOM elements
            const setupPanel = document.getElementById('setupPanel');
            const results = document.getElementById('results');
            
            if (setupPanel) {
                setupPanel.style.display = 'none';
            } else {
                console.error('‚ùå setupPanel element not found in showResults!');
            }
            
            if (results) {
                results.style.display = 'block';
            } else {
                console.error('‚ùå results element not found in showResults!');
                alert('Fehler: Ergebnis-Bereich nicht gefunden. Seite neu laden.');
                return;
            }
            
            // Show debug buttons in results if debug mode is active
            if (isDebugMode()) {
                const debugResultsElement = document.getElementById('debugButtonsResults');
                if (debugResultsElement) {
                    debugResultsElement.style.display = 'block';
                }
            }
            
            // Show different content based on whether data exists
            if (hasData) {
                const latestResult = userData[userData.length - 1];
                displayResults(latestResult);
            } else {
                // Show empty state with import options
                displayEmptyResults(userCode);
            }
            
            const stats = hasData ? calculateTestStatistics(userData) : null;
            document.getElementById('dataStatus').innerHTML = hasData ? `
                <h4>üìà Ihre bisherigen Tests (${userData.length} Durchg√§nge):</h4>
                ${stats ? `
                <div style="background: white; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <strong>üìä Statistik:</strong><br>
                    üü¢ Mit Medikation: ${stats.testsWithMedication} Tests (√ò ${stats.avgAccuracyWith}% Genauigkeit)<br>
                    üîµ Ohne Medikation: ${stats.testsWithoutMedication} Tests (√ò ${stats.avgAccuracyWithout}% Genauigkeit)<br>
                    ${stats.improvement > 0 ? `‚úÖ Verbesserung: +${stats.improvement}%` : 
                    stats.improvement < 0 ? `‚ùå Verschlechterung: ${stats.improvement}%` : '‚ûñ Keine √Ñnderung'}
                </div>
                ` : ''}
                <div style="max-height: 300px; overflow-y: auto; margin-top: 10px;">
                    ${userData.map((result, i) => {
                        const testDate = result.timestamp ? new Date(result.timestamp) : new Date();
                        const dateStr = testDate.toLocaleDateString('de-DE', {
                            year: 'numeric', month: '2-digit', day: '2-digit'
                        });
                        const timeStr = testDate.toLocaleTimeString('de-DE', {
                            hour: '2-digit', minute: '2-digit'
                        });
                        
                        const accuracy = result.overallAccuracy || 0;
                        const totalCorrect = result.totalCorrect || 0;
                        const totalIncorrect = result.totalIncorrect || 0;
                        const concentrationIndex = result.concentrationIndex !== undefined ? result.concentrationIndex : (totalCorrect - totalIncorrect);
                        const processingSpeed = result.processingSpeed || 0;
                        
                        return `
                        <div style="padding: 12px; margin: 8px 0; background: white; border-radius: 8px; border-left: 4px solid ${result.medication === 'mit' ? '#4CAF50' : '#2196F3'}; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="color: #333;">Test ${i + 1}</strong>
                                <span style="color: #666; font-size: 0.9em;">${dateStr}, ${timeStr}</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9em;">
                                <div>${result.medication === 'mit' ? 'üíä Mit' : 'üö´ Ohne'} Medikation</div>
                                <div>üéØ ${accuracy.toFixed(1)}% Genauigkeit</div>
                                <div>‚úÖ ${totalCorrect} Richtige</div>
                                <div>‚ùå ${totalIncorrect} Fehler</div>
                                <div>üß† Index: ${concentrationIndex}</div>
                                <div>‚è±Ô∏è ${processingSpeed.toFixed(1)} Items/Min</div>
                            </div>
                            <div style="margin-top: 6px; font-size: 0.8em; color: #666;">
                                Eingabe: ${result.inputMethod || 'unbekannt'}
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            ` : `
                <h4>üì≠ Keine Daten f√ºr Code "${userCode}" gefunden</h4>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 10px 0; text-align: center;">
                    <p style="margin-bottom: 15px;">üîç Es wurden noch keine Testergebnisse f√ºr diesen Code gefunden.</p>
                    <p style="margin-bottom: 20px;">Sie k√∂nnen:</p>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn" onclick="goToSetup()" style="background: #28a745; color: white;">üöÄ Ersten Test starten</button>
                        <button class="btn" onclick="importData()" style="background: #007bff; color: white;">üìÅ Daten importieren</button>
                    </div>
                </div>
            `;
        }

        function deleteData() {
            const userCode = document.getElementById('userCode').value.trim();
            if (!userCode) {
                alert('Bitte geben Sie Ihren Code ein!');
                return;
            }
            
            if (confirm(`Alle Daten f√ºr Code "${userCode}" wirklich l√∂schen?`)) {
                let localData = JSON.parse(localStorage.getItem('d2TestData') || '[]');
                localData = localData.filter(result => result.userCode !== userCode);
                localStorage.setItem('d2TestData', JSON.stringify(localData));
                
                const cookieName = `d2_${userCode}`;
                document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
                
                alert('Daten wurden gel√∂scht!');
                document.getElementById('dataStatus').innerHTML = `
                    <div class="success">‚úÖ Alle Daten f√ºr "${userCode}" wurden aus Cookies und LocalStorage gel√∂scht!</div>
                `;
            }
        }

        // Detaillierte L√∂sch-Best√§tigung mit genauer Erkl√§rung
        function deleteDataWithConfirmation() {
            const userCode = document.getElementById('userCode').value.trim();
            if (!userCode) {
                alert('Bitte geben Sie Ihren Code ein!');
                return;
            }
            
            // Pr√ºfe, welche Daten vorhanden sind
            const localData = JSON.parse(localStorage.getItem('d2TestData') || '[]');
            const userLocalData = localData.filter(result => result.userCode === userCode);
            const cookieName = `d2_${userCode}`;
            const cookieExists = document.cookie.includes(cookieName);
            
            if (userLocalData.length === 0 && !cookieExists) {
                alert(`Keine Daten f√ºr User "${userCode}" gefunden.`);
                return;
            }
            
            // Detaillierte Best√§tigungsmeldung
            let confirmMessage = `‚ö†Ô∏è DATEN L√ñSCHEN - Best√§tigung erforderlich\n\n`;
            confirmMessage += `User-Code: "${userCode}"\n\n`;
            confirmMessage += `Folgende Daten werden PERMANENT gel√∂scht:\n\n`;
            
            if (userLocalData.length > 0) {
                confirmMessage += `üìä LocalStorage (Browser-Speicher):\n`;
                confirmMessage += `   ‚Ä¢ ${userLocalData.length} Testergebnis(se)\n`;
                confirmMessage += `   ‚Ä¢ Alle Statistiken und Verlaufsdaten\n\n`;
            }
            
            if (cookieExists) {
                confirmMessage += `üç™ Browser-Cookies:\n`;
                confirmMessage += `   ‚Ä¢ Cookie "${cookieName}"\n`;
                confirmMessage += `   ‚Ä¢ Gespeicherte Test-Einstellungen\n\n`;
            }
            
            confirmMessage += `‚ö†Ô∏è ACHTUNG: Diese Aktion kann NICHT r√ºckg√§ngig gemacht werden!\n\n`;
            confirmMessage += `üíæ EMPFEHLUNG: Erstellen Sie vorher ein Backup √ºber\n`;
            confirmMessage += `   "üíæ Cookie-Daten speichern" um die Daten sp√§ter\n`;
            confirmMessage += `   √ºber "üìÅ Daten importieren" wiederherstellen zu k√∂nnen.\n\n`;
            confirmMessage += `Betroffen: NUR der aktuelle User "${userCode}"\n`;
            confirmMessage += `Andere User-Daten bleiben unber√ºhrt.\n\n`;
            confirmMessage += `Wirklich fortfahren?`;
            
            if (confirm(confirmMessage)) {
                // L√∂sche LocalStorage-Daten
                const updatedLocalData = localData.filter(result => result.userCode !== userCode);
                localStorage.setItem('d2TestData', JSON.stringify(updatedLocalData));
                
                // L√∂sche Cookie
                document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
                
                // Erfolgsmeldung
                const deletedItems = [];
                if (userLocalData.length > 0) deletedItems.push(`${userLocalData.length} Testergebnis(se) aus LocalStorage`);
                if (cookieExists) deletedItems.push(`Cookie "${cookieName}"`);
                
                alert(`‚úÖ Erfolgreich gel√∂scht:\n\n${deletedItems.join('\n')}\n\nAlle Daten f√ºr User "${userCode}" wurden permanent entfernt.`);
                
                // Status-Update
                const statusElement = document.getElementById('dataStatus');
                if (statusElement) {
                    statusElement.innerHTML = `
                        <div class="success">‚úÖ Alle Daten f√ºr User "${userCode}" wurden permanent gel√∂scht!</div>
                    `;
                }
            }
        }

        function exportData() {
            const userCode = document.getElementById('userCode').value.trim() || currentTest.userCode;
            if (!userCode) {
                alert('Bitte geben Sie einen Code ein!');
                return;
            }
            
            console.log('=== EXPORT DATA FOR:', userCode, '===');
            
            let localData = [];
            try {
                localData = JSON.parse(localStorage.getItem('d2TestData') || '[]');
                console.log('LocalStorage total entries:', localData.length);
            } catch (e) {
                console.error('LocalStorage load error:', e);
            }
            
            let cookieData = [];
            try {
                cookieData = loadFromCookies(userCode);
                console.log('Cookie entries for user:', cookieData.length);
            } catch (e) {
                console.error('Cookie load error:', e);
            }
            
            const localUserData = localData.filter(result => result.userCode === userCode);
            console.log('LocalStorage entries for', userCode + ':', localUserData.length);
            
            const allData = [...localUserData, ...cookieData];
            const userData = allData
                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
                .filter((item, index, arr) => 
                    index === arr.findIndex(t => t.timestamp === item.timestamp)
                );
            
            console.log('Final merged data for export:', userData.length);
            
            if (userData.length === 0) {
                const debugInfo = `
Keine Daten f√ºr "${userCode}" gefunden!

Debug-Info:
‚Ä¢ LocalStorage Gesamt: ${localData.length} Eintr√§ge
‚Ä¢ LocalStorage f√ºr User: ${localUserData.length} Eintr√§ge  
‚Ä¢ Cookies f√ºr User: ${cookieData.length} Eintr√§ge
‚Ä¢ Verf√ºgbare User-Codes: ${[...new Set(localData.map(r => r.userCode))].join(', ') || 'keine'}

Tipp: 
1. F√ºhren Sie zuerst einen Test durch
2. Oder verwenden Sie "üîß Speicher testen" um Test-Daten zu erstellen
3. Oder importieren Sie eine vorhandene Datei
                `;
                
                alert(debugInfo);
                return;
            }
            
            const exportData = {
                userCode: userCode,
                exportDate: new Date().toISOString(),
                testCount: userData.length,
                version: '1.0',
                results: userData,
                statistics: calculateTestStatistics(userData),
                exportSource: 'localStorage+cookies'
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            const isoDate = new Date().toISOString().split('T')[0];
            a.href = url;
            a.download = `d2-test-${userCode}-${isoDate}.json`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ ${userData.length} Tests exportiert als: d2-test-${userCode}-${isoDate}.json`);
            console.log('=== EXPORT COMPLETED ===');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        let userCode, testResults, exportDate;
                        
                        // Handle new export format (from saveCookieDataToFile)
                        if (importedData.exportInfo && importedData.cookieData) {
                            userCode = importedData.exportInfo.userCode;
                            exportDate = importedData.exportInfo.exportDate;
                            testResults = [];
                            
                            // Extract test results from localStorage data
                            if (importedData.cookieData.localStorage_d2TestData && Array.isArray(importedData.cookieData.localStorage_d2TestData)) {
                                testResults = importedData.cookieData.localStorage_d2TestData.filter(result => result.userCode === userCode);
                            }
                            
                            // Also check cookie data for additional results
                            Object.keys(importedData.cookieData).forEach(cookieName => {
                                if (cookieName.startsWith('d2_') && cookieName !== 'localStorage_d2TestData') {
                                    const cookieData = importedData.cookieData[cookieName];
                                    if (Array.isArray(cookieData)) {
                                        testResults.push(...cookieData.filter(result => result.userCode === userCode));
                                    } else if (cookieData && cookieData.userCode === userCode) {
                                        testResults.push(cookieData);
                                    }
                                }
                            });
                        }
                        // Handle old format (legacy)
                        else if (importedData.userCode && importedData.results && Array.isArray(importedData.results)) {
                            userCode = importedData.userCode;
                            testResults = importedData.results;
                            exportDate = importedData.exportDate;
                        }
                        else {
                            throw new Error('Ung√ºltiges Datenformat. Erwartet wird eine D2-Test Export-Datei.');
                        }
                        
                        if (!userCode || !Array.isArray(testResults)) {
                            throw new Error('Keine g√ºltigen Testdaten gefunden.');
                        }
                        
                        // Remove duplicates and merge with existing data
                        let localData = JSON.parse(localStorage.getItem('d2TestData') || '[]');
                        localData = localData.filter(result => result.userCode !== userCode);
                        
                        // Remove duplicates within imported data (by timestamp)
                        const uniqueResults = [];
                        const seenTimestamps = new Set();
                        testResults.forEach(result => {
                            if (result.timestamp && !seenTimestamps.has(result.timestamp)) {
                                seenTimestamps.add(result.timestamp);
                                uniqueResults.push(result);
                            }
                        });
                        
                        localData.push(...uniqueResults);
                        localStorage.setItem('d2TestData', JSON.stringify(localData));
                        
                        // Save to cookies
                        uniqueResults.forEach(result => {
                            saveToCookies(result);
                        });
                        
                        alert(`‚úÖ ${uniqueResults.length} Tests f√ºr "${userCode}" erfolgreich importiert!`);
                        
                        document.getElementById('userCode').value = userCode;
                        
                        const exportDateStr = exportDate ? new Date(exportDate).toLocaleDateString('de-DE') : 'Unbekannt';
                        document.getElementById('dataStatus').innerHTML = `
                            <div class="success">
                                ‚úÖ Import erfolgreich!<br>
                                ${uniqueResults.length} Tests f√ºr "${userCode}" wurden importiert.<br>
                                Exportdatum: ${exportDateStr}
                            </div>
                        `;
                        
                    } catch (error) {
                        alert('‚ùå Fehler beim Importieren: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function saveToCookies(result) {
            const cookieName = `d2_${result.userCode}`;
            let existingData = getCookieData(cookieName);
            existingData.push(result);
            
            if (existingData.length > 10) {
                existingData = existingData.slice(-10);
            }
            
            try {
                const cookieValue = encodeURIComponent(JSON.stringify(existingData));
                const expiryDate = new Date();
                expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                
                document.cookie = `${cookieName}=${cookieValue}; expires=${expiryDate.toUTCString()}; path=/; SameSite=Lax`;
                console.log('Cookie saved successfully for', result.userCode);
            } catch (e) {
                console.error('Cookie save failed:', e);
                try {
                    const singleResult = encodeURIComponent(JSON.stringify([result]));
                    document.cookie = `${cookieName}=${singleResult}; expires=${expiryDate.toUTCString()}; path=/; SameSite=Lax`;
                } catch (e2) {
                    console.error('Even single result cookie failed:', e2);
                }
            }
        }

        function resetTest() {
            document.getElementById('results').style.display = 'none';
            document.getElementById('setupPanel').style.display = 'block';
            
            currentTest = {
                rows: [],
                currentRowIndex: 0,
                startTime: null,
                rowStartTime: null,
                results: [],
                userCode: '',
                medication: '',
                inputMethod: 'mouse',
                deviceInfo: getDeviceInfo()
            };
            
            clearInterval(rowTimer);
            testRunning = false;

            document.getElementById('nextBtn').style.display = 'inline-block';
            document.getElementById('finishBtn').style.display = 'none';
        }

        function calculateTestStatistics(userData) {
            if (!userData || userData.length === 0) return null;
            
            const withMedication = userData.filter(r => r.medication === 'mit');
            const withoutMedication = userData.filter(r => r.medication === 'ohne');
            
            const avgAccuracyWith = withMedication.length > 0 ? 
                withMedication.reduce((sum, r) => sum + r.overallAccuracy, 0) / withMedication.length : 0;
            const avgAccuracyWithout = withoutMedication.length > 0 ? 
                withoutMedication.reduce((sum, r) => sum + r.overallAccuracy, 0) / withoutMedication.length : 0;
            
            return {
                totalTests: userData.length,
                testsWithMedication: withMedication.length,
                testsWithoutMedication: withoutMedication.length,
                avgAccuracyWith: avgAccuracyWith.toFixed(1),
                avgAccuracyWithout: avgAccuracyWithout.toFixed(1),
                improvement: (avgAccuracyWith - avgAccuracyWithout).toFixed(1),
                latestTest: userData[userData.length - 1]
            };
        }

        function testStorage() {
            console.log('=== COMPREHENSIVE STORAGE TEST ===');
            
            localStorage.removeItem('d2TestData');
            document.cookie.split(";").forEach(function(c) { 
                const cookieName = c.trim().split("=")[0];
                if (cookieName.startsWith('d2_')) {
                    document.cookie = cookieName + '=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/'; 
                }
            });
            
            let statusMessages = [];

            try {
                localStorage.setItem('test', 'works');
                const localTest = localStorage.getItem('test');
                if (localTest === 'works') {
                    statusMessages.push('‚úÖ LocalStorage basic test: OK');
                } else {
                    statusMessages.push('‚ùå LocalStorage basic test: FAILED');
                }
                localStorage.removeItem('test');
                
                const testResultLS = {
                    userCode: 'TEST123LS',
                    timestamp: new Date().toISOString(),
                    medication: 'ohne',
                    totalCorrect: 42,
                    overallAccuracy: 85.5
                };
                
                localStorage.setItem('d2TestData', JSON.stringify([testResultLS]));
                const retrievedLS = JSON.parse(localStorage.getItem('d2TestData') || '[]');
                if (retrievedLS.length === 1 && retrievedLS[0].userCode === 'TEST123LS') {
                    statusMessages.push('‚úÖ LocalStorage d2 data test: OK');
                } else {
                    statusMessages.push('‚ùå LocalStorage d2 data test: FAILED');
                }
                
            } catch (e) {
                statusMessages.push(`‚ùå LocalStorage test: FAILED - ${e.message}`);
            }
            
            try {
                document.cookie = 'testcookie=works; path=/';
                const cookieTest = document.cookie.includes('testcookie=works');
                if (cookieTest) {
                    statusMessages.push('‚úÖ Cookie basic test: OK');
                } else {
                    statusMessages.push('‚ùå Cookie basic test: FAILED');
                }
                document.cookie = 'testcookie=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/';
                
                const testCookieData = [{userCode: 'TEST123C', score: 42, timestamp: new Date().toISOString()}];
                const cookieValue = encodeURIComponent(JSON.stringify(testCookieData));
                document.cookie = `d2_TEST123C=${cookieValue}; path=/; max-age=${365 * 24 * 60 * 60}`;
                
                const cookieRetrieved = getCookieData('d2_TEST123C');
                if (cookieRetrieved.length === 1 && cookieRetrieved[0].userCode === 'TEST123C') {
                    statusMessages.push('‚úÖ Cookie d2 data test: OK');
                } else {
                    statusMessages.push('‚ùå Cookie d2 data test: FAILED');
                }
                
            } catch (e) {
                statusMessages.push(`‚ùå Cookie test: FAILED - ${e.message}`);
            }
            
            try {
                const testUser = 'Michael271274';
                const fullTestResult = {
                    userCode: testUser,
                    timestamp: new Date().toISOString(),
                    medication: 'mit',
                    inputMethod: 'mouse',
                    deviceInfo: getDeviceInfo(),
                    totalCorrect: 35,
                    totalIncorrect: 3,
                    overallAccuracy: 92.1,
                    processingSpeed: 15.5,
                    concentrationIndex: 32,
                    rowResults: [{rowNumber: 1, correct: 3, incorrect: 0}]
                };
                
                const saveResult = saveTestResult(fullTestResult);
                if (saveResult) {
                    statusMessages.push('‚úÖ Full save cycle: OK');
                } else {
                    statusMessages.push('‚ùå Full save cycle: FAILED');
                }
                
                document.getElementById('userCode').value = testUser;
                let loadedData = JSON.parse(localStorage.getItem('d2TestData') || '[]');
                let loadedCookieData = loadFromCookies(testUser);
                const allLoadedData = [...loadedData, ...loadedCookieData];
                const userResults = allLoadedData.filter(r => r.userCode === testUser);

                if (userResults.length > 0) {
                    statusMessages.push('‚úÖ Full load cycle: OK (found ' + userResults.length + ' results for ' + testUser + ')');
                } else {
                    statusMessages.push('‚ùå Full load cycle: FAILED (no results found for ' + testUser + ')');
                }
                
            } catch (e) {
                statusMessages.push(`‚ùå Full cycle test: FAILED - ${e.message}`);
            }
            
            const currentLocal = JSON.parse(localStorage.getItem('d2TestData') || '[]');
            const currentCookiesCount = document.cookie.split(';').filter(c => c.trim().startsWith('d2_')).length;
            
            statusMessages.push(`Current state:`);
            statusMessages.push(`- LocalStorage entries: ${currentLocal.length}`);
            statusMessages.push(`- Cookie entries for d2 users: ${currentCookiesCount}`);
            
            const statusElement = document.getElementById('dataStatus');
            if (statusElement) {
                statusElement.innerHTML = `
                    <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin: 10px 0; font-family: monospace;">
                        <h4>üîß Speicher-Test Ergebnisse:</h4>
                        ${statusMessages.map(msg => `<p>${msg}</p>`).join('')}
                        <p>üìä Test-User "Michael271274" wurde erstellt und gespeichert.</p>
                        <p><strong>‚û°Ô∏è Sie k√∂nnen jetzt "Eigene Ergebnisse anzeigen" testen!</strong></p>
                    </div>
                `;
            }
            
            console.log('=== END COMPREHENSIVE STORAGE TEST ===');
            alert('‚úÖ Speicher-Test abgeschlossen! Schauen Sie in die Browser-Konsole (F12) f√ºr Details.');
        }

        function createTestData() {
            const dummyUserCode = document.getElementById('userCode').value.trim() || 'DummyUser' + Math.floor(Math.random() * 1000);
            const dummyMedication = ['ohne', 'mit'][Math.floor(Math.random() * 2)];
            
            currentTest.userCode = dummyUserCode;
            currentTest.medication = dummyMedication;
            currentTest.deviceInfo = getDeviceInfo();
            currentTest.inputMethod = 'mouse';

            const dummyResults = [];
            for (let i = 0; i < 14; i++) {
                dummyResults.push({
                    rowNumber: i + 1,
                    correct: Math.floor(Math.random() * 20) + 20,
                    incorrect: Math.floor(Math.random() * 5),
                    missed: Math.floor(Math.random() * 5),
                    totalTargets: 47,
                    timeSpent: Math.floor(Math.random() * 5) + 15,
                    processed: Math.floor(Math.random() * 40) + 5,
                    accuracy: (Math.random() * 40 + 60).toFixed(1)
                });
            }

            currentTest.results = dummyResults;
            currentTest.startTime = new Date(Date.now() - (14 * 20 * 1000));

            const totalResult = calculateTotalResult();
            saveTestResult(totalResult);

            alert(`Dummy-Daten f√ºr "${dummyUserCode}" erstellt und gespeichert. Du kannst jetzt "Eigene Ergebnisse anzeigen" verwenden.`);
            document.getElementById('userCode').value = dummyUserCode;
            document.getElementById('medication').value = dummyMedication;
        }


        
        // üìù Single Row Test - limits test to just 1 row for debugging
        function runSingleRowTest() {
            const userCode = document.getElementById('userCode').value.trim() || 'SingleTest' + Date.now();
            const medication = document.getElementById('medication').value || 'ohne';
            
            console.log('üìù Starting single row test...');
            
            // Temporarily modify test to only run 1 row
            window.debugSingleRow = true;
            
            currentTest.userCode = userCode;
            currentTest.medication = medication;
            currentTest.deviceInfo = getDeviceInfo();
            currentTest.inputMethod = 'mouse';
            currentTest.startTime = new Date();
            currentTest.results = [];
            
            alert('üîß Debug: Test l√§uft nur 1 Zeile. Nach 20 Sekunden wird automatisch beendet.');
            
            // Start normal test
            startTest();
        }
        


        function syncData() {
            const userCode = document.getElementById('userCode').value.trim();
            if (!userCode) {
                alert('Bitte geben Sie Ihren Code ein!');
                return;
            }
            
            const localData = JSON.parse(localStorage.getItem('d2TestData') || '[]');
            const cookieData = loadFromCookies(userCode);
            
            const allData = [...localData, ...cookieData];
            const uniqueData = allData.filter((item, index, arr) => 
                index === arr.findIndex(t => t.timestamp === item.timestamp && t.userCode === item.userCode)
            );
            
            localStorage.setItem('d2TestData', JSON.stringify(uniqueData));
            
            const userData = uniqueData.filter(result => result.userCode === userCode);
            if (userData.length > 0) {
                const cookieName = `d2_${userCode}`;
                document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
                
                const cookiesToSave = userData.slice(-5);
                const cookieValue = encodeURIComponent(JSON.stringify(cookiesToSave));
                const expiryDate = new Date();
                expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                document.cookie = `${cookieName}=${cookieValue}; expires=${expiryDate.toUTCString()}; path=/; SameSite=Lax`;
            }
            
            alert(`‚úÖ Daten synchronisiert! ${uniqueData.length} Eintr√§ge insgesamt gespeichert.`);
            document.getElementById('dataStatus').innerHTML = `
                <div class="success">‚úÖ Daten erfolgreich synchronisiert! Es wurden ${uniqueData.length} eindeutige Eintr√§ge gefunden und gespeichert.</div>
            `;
        }

        function showStorageInfo() {
            const localData = JSON.parse(localStorage.getItem('d2TestData') || '[]');
            const localSize = new TextEncoder().encode(JSON.stringify(localData)).length;
            
            let cookieSize = 0;
            let cookieCount = 0;
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const trimmedCookie = cookie.trim();
                const [name, value] = trimmedCookie.split('=');
                if (name.startsWith('d2_')) {
                    cookieCount++;
                    cookieSize += new TextEncoder().encode(trimmedCookie).length;
                }
            }
            
            const info = `
                <div style="background: white; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <h4>üíæ Speicher-Information:</h4>
                    <p><strong>LocalStorage:</strong> ${localData.length} Tests (${(localSize/1024).toFixed(2)} KB)</p>
                    <p><strong>Cookies:</strong> ${cookieCount} Benutzer-Cookies (${(cookieSize/1024).toFixed(2)} KB)</p>
                    <p><strong>Browser:</strong> ${navigator.userAgent}</p>
                    <p><strong>Speicher verf√ºgbar (gesch√§tzt):</strong> ${navigator.storage && navigator.storage.estimate ? '‚úÖ' : '‚ùå Info nicht verf√ºgbar'}</p>
                </div>
            `;
            
            const dataStatusElement = document.getElementById('dataStatus');
            if (dataStatusElement) {
                dataStatusElement.innerHTML = info;
                if (navigator.storage && navigator.storage.estimate) {
                    navigator.storage.estimate().then(estimate => {
                        const storageInfoHtml = `
                            <div style="background: white; padding: 15px; border-radius: 8px; margin: 10px 0;">
                                <h4>üíæ Speicher-Information:</h4>
                                <p><strong>LocalStorage:</strong> ${localData.length} Tests (${(localSize/1024).toFixed(2)} KB)</p>
                                <p><strong>Cookies:</strong> ${cookieCount} Benutzer-Cookies (${(cookieSize/1024).toFixed(2)} KB)</p>
                                <p><strong>Browser:</strong> ${navigator.userAgent}</p>
                                <p><strong>Speicher verf√ºgbar (gesch√§tzt):</strong> ‚úÖ ${(estimate.usage/1024/1024).toFixed(2)} MB von ${(estimate.quota/1024/1024).toFixed(2)} MB belegt.</p>
                            </div>
                        `;
                        dataStatusElement.innerHTML = storageInfoHtml;
                    });
                }
            }
        }

        function createBackup() {
            const allLocalDataRaw = localStorage.getItem('d2TestData');
            let allLocalData = [];
            try {
                allLocalData = JSON.parse(allLocalDataRaw || '[]');
            } catch (e) {
                console.error('Error parsing localStorage for backup:', e);
                alert('Fehler beim Lesen des LocalStorage f√ºr das Backup. Backup ist m√∂glicherweise unvollst√§ndig.');
            }

            const allUsersCookieData = {};
            
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name.startsWith('d2_')) {
                    const userCode = name.substring(3);
                    try {
                        allUsersCookieData[userCode] = JSON.parse(decodeURIComponent(value));
                    } catch (e) {
                        console.warn('Could not parse cookie data for', userCode, ':', e);
                    }
                }
            }
            
            const backup = {
                version: '1.0',
                created: new Date().toISOString(),
                localStorageContent: allLocalData,
                cookieContent: allUsersCookieData,
                totalUsersBackedUp: Object.keys(allUsersCookieData).length,
                settingsAtBackup: {
                    userCode: document.getElementById('userCode').value,
                    medication: document.getElementById('medication').value
                }
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            const isoDate = new Date().toISOString().split('T')[0];
            a.href = url;
            a.download = `d2-test-backup-${isoDate}.json`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`Vollst√§ndiges Backup erstellt: d2-test-backup-${isoDate}.json`);
        }



        // Prevent accidental page reload during test
        window.addEventListener('beforeunload', function(e) {
            if (testRunning) {
                const confirmationMessage = 'Der Test l√§uft noch. M√∂chten Sie wirklich die Seite verlassen?';
                e.returnValue = confirmationMessage;
                return confirmationMessage;
            }
        });

        // Touch event optimization
        document.addEventListener('touchmove', function(e) {
            if (testRunning) {
                e.preventDefault();
            }
        }, { passive: false });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (testRunning) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    if (!document.getElementById('nextBtn').disabled) {
                        nextRow();
                    }
                }
                if (e.key === 'Escape') {
                    if (confirm('Test wirklich abbrechen?')) {
                        resetTest();
                    }
                }
            }
            
            // Keyboard navigation for symbols
            if (testRunning && e.target.classList.contains('symbol')) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    e.target.click();
                }
            }
        });

        // Error handling
        window.addEventListener('error', function(e) {
            console.error('d2-Test Error:', e.error);
            if (testRunning) {
                const partialResult = {
                    ...calculateTotalResult(),
                    error: e.error.message,
                    incomplete: true
                };
                saveTestResult(partialResult);
            }
        });

        // Responsive design adjustments
        function adjustForScreenSize() {
            const width = window.innerWidth;
            const symbolElements = document.querySelectorAll('.symbol');
            
            if (width < 768) {
                symbolElements.forEach(el => {
                    el.style.fontSize = '1.2em';
                    el.style.padding = '4px';
                });
            } else if (width >= 768 && width < 1024) {
                symbolElements.forEach(el => {
                    el.style.fontSize = '1.4em';
                    el.style.padding = '6px';
                });
            } else {
                symbolElements.forEach(el => {
                    el.style.fontSize = '';
                    el.style.padding = '';
                });
            }
            
            const currentDisplayResult = JSON.parse(localStorage.getItem('d2TestData') || '[]')
                                        .filter(r => r.userCode === document.getElementById('userCode').value.trim())
                                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
                                        .pop();
            if (document.getElementById('results').style.display === 'block' && currentDisplayResult) {
                drawProgressChart(currentDisplayResult);
            }
        }

        window.addEventListener('resize', adjustForScreenSize);
        window.addEventListener('orientationchange', adjustForScreenSize);

        console.log('d2-Test Application loaded successfully with Cookie support!');
        console.log('Device Info:', getDeviceInfo());

        // Debug Mode Functions
        function showCookieData() {
            const userCode = document.getElementById('userCode').value.trim();
            if (!userCode) {
                alert('Bitte geben Sie zuerst Ihren User-Code ein!');
                return;
            }
            
            const cookieData = getCookieData(`d2_${userCode}`);
            const cookieText = document.cookie;
            
            let output = `=== COOKIE-DATEN F√úR USER: ${userCode} ===\n\n`;
            output += `Vollst√§ndiger Cookie-String:\n${cookieText}\n\n`;
            output += `Geparste D2-Daten (${cookieData.length} Eintr√§ge):\n`;
            
            if (cookieData.length === 0) {
                output += 'Keine D2-Testdaten in Cookies gefunden.\n';
            } else {
                cookieData.forEach((entry, index) => {
                    output += `\nEintrag ${index + 1}:\n`;
                    output += `- Timestamp: ${entry.timestamp}\n`;
                    output += `- Medikation: ${entry.medication}\n`;
                    output += `- Genauigkeit: ${entry.overallAccuracy}%\n`;
                    output += `- Korrekte Markierungen: ${entry.totalCorrect}\n`;
                    output += `- Input-Methode: ${entry.inputMethod || 'nicht verf√ºgbar'}\n`;
                    if (entry.deviceInfo) {
                        output += `- Ger√§t: ${entry.deviceInfo.userAgent}\n`;
                    }
                });
            }
            
            // Create modal dialog with unique ID
            const modalId = 'cookieModal_' + Date.now();
            const modal = document.createElement('div');
            modal.id = modalId;
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; padding: 30px; border-radius: 10px;
                max-width: 80%; max-height: 80%; overflow: auto;
                font-family: monospace; font-size: 12px;
            `;
            
            content.innerHTML = `
                <h3>üç™ Cookie-Daten f√ºr ${userCode}</h3>
                <textarea readonly id="cookieOutput_${modalId}" style="width: 100%; height: 400px; font-family: monospace; font-size: 11px;">${output}</textarea>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="closeModal('${modalId}')" class="btn">Schlie√üen</button>
                    <button onclick="copyToClipboard('cookieOutput_${modalId}')" class="btn btn-primary">In Zwischenablage kopieren</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }

        function copyToClipboard(textareaId) {
            const textarea = document.getElementById(textareaId);
            if (textarea) {
                textarea.select();
                textarea.setSelectionRange(0, 99999); // For mobile devices
                
                // Try modern clipboard API first
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(textarea.value).then(() => {
                        alert('üìã In Zwischenablage kopiert!');
                    }).catch(err => {
                        console.error('Clipboard API failed:', err);
                        fallbackCopy(textarea);
                    });
                } else {
                    // Fallback for older browsers
                    fallbackCopy(textarea);
                }
            }
        }

        function fallbackCopy(textarea) {
            try {
                document.execCommand('copy');
                alert('üìã In Zwischenablage kopiert!');
            } catch (err) {
                console.error('Copy failed:', err);
                alert('‚ö†Ô∏è Kopieren fehlgeschlagen. Bitte manuell markieren und kopieren.');
            }
        }

        function downloadCookieData() {
            const userCode = document.getElementById('userCode').value.trim();
            if (!userCode) {
                alert('Bitte geben Sie zuerst Ihren User-Code ein!');
                return;
            }
            
            try {
                const cookieData = getCookieData(`d2_${userCode}`);
                const allCookies = document.cookie;
                
                const debugData = {
                    userCode: userCode,
                    timestamp: new Date().toISOString(),
                    fullCookieString: allCookies,
                    parsedD2Data: cookieData,
                    localStorage: JSON.parse(localStorage.getItem('d2TestData') || '[]'),
                    debugInfo: {
                        url: window.location.href,
                        userAgent: navigator.userAgent,
                        cookieEnabled: navigator.cookieEnabled,
                        storageQuota: 'unknown',
                        downloadPath: 'Browser-Standard Downloads-Ordner'
                    }
                };
                
                const jsonString = JSON.stringify(debugData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                // Erstelle Download-Link mit verbesserter Kompatibilit√§t
                const link = document.createElement('a');
                link.href = url;
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                link.download = `d2-debug-${userCode}-${timestamp}.json`;
                
                // Stelle sicher, dass der Download funktioniert
                link.style.display = 'none';
                document.body.appendChild(link);
                
                // Trigger download
                link.click();
                
                // Cleanup
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 100);
                
                // Benutzerfreundliche Meldung
                alert(`üì• Debug-Daten f√ºr "${userCode}" werden in Ihren Downloads-Ordner heruntergeladen!\n\nDateiname: d2-debug-${userCode}-${timestamp}.json\n\nHinweis: Die Datei wird automatisch in Ihrem Standard-Downloads-Ordner gespeichert.`);
                
            } catch (error) {
                console.error('Download-Fehler:', error);
                alert('‚ùå Fehler beim Herunterladen der Debug-Daten. Bitte versuchen Sie es erneut oder pr√ºfen Sie die Browser-Konsole.');
            }
        }

        function showAllStorageData() {
            const localData = JSON.parse(localStorage.getItem('d2TestData') || '[]');
            const allCookies = document.cookie;
            
            let output = '=== ALLE SPEICHERDATEN ===\n\n';
            output += `LocalStorage (${localData.length} Eintr√§ge):\n`;
            localData.forEach((entry, index) => {
                output += `${index + 1}. ${entry.userCode} - ${entry.timestamp} - ${entry.overallAccuracy}%\n`;
            });
            
            output += '\n=== ALLE COOKIES ===\n';
            output += allCookies || 'Keine Cookies gefunden';
            
            output += '\n\n=== D2-SPEZIFISCHE COOKIES ===\n';
            const d2Cookies = document.cookie.split(';').filter(cookie => cookie.trim().startsWith('d2_'));
            if (d2Cookies.length === 0) {
                output += 'Keine D2-Cookies gefunden\n';
            } else {
                d2Cookies.forEach(cookie => {
                    const [name, value] = cookie.trim().split('=');
                    output += `${name}: ${value ? value.substring(0, 100) + '...' : 'leer'}\n`;
                });
            }
            
            // Create modal with unique ID
            const modalId = 'storageModal_' + Date.now();
            const modal = document.createElement('div');
            modal.id = modalId;
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; padding: 30px; border-radius: 10px;
                max-width: 90%; max-height: 80%; overflow: auto;
            `;
            
            content.innerHTML = `
                <h3>üìä Alle Speicherdaten</h3>
                <textarea readonly style="width: 100%; height: 400px; font-family: monospace; font-size: 11px;">${output}</textarea>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="closeModal('${modalId}')" class="btn">Schlie√üen</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        function clearAllDebugData() {
            if (!confirm('‚ö†Ô∏è Wirklich ALLE Debug-Daten l√∂schen?\n\nDies l√∂scht:\n- Alle LocalStorage-Daten\n- Alle D2-Cookies\n\nDieser Vorgang kann nicht r√ºckg√§ngig gemacht werden!')) {
                return;
            }
            
            // Clear localStorage
            localStorage.removeItem('d2TestData');
            
            // Clear all D2 cookies
            const d2Cookies = document.cookie.split(';').filter(cookie => cookie.trim().startsWith('d2_'));
            d2Cookies.forEach(cookie => {
                const cookieName = cookie.trim().split('=')[0];
                document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;
            });
            
            alert('üóëÔ∏è Alle Debug-Daten wurden gel√∂scht!');
            
            // Reload page to reflect changes
            if (confirm('Seite neu laden, um √Ñnderungen zu sehen?')) {
                window.location.reload();
            }
        }

        function deleteAllCookies() {
            if (!confirm('‚ö†Ô∏è Wirklich ALLE D2-Test Cookies l√∂schen?\n\nDies l√∂scht alle gespeicherten Testergebnisse!\nDieser Vorgang kann nicht r√ºckg√§ngig gemacht werden!')) {
                return;
            }
            
            let deletedCount = 0;
            
            // Find all D2 cookies
            const allCookies = document.cookie.split(';');
            const d2Cookies = allCookies.filter(cookie => {
                const cookieName = cookie.trim().split('=')[0];
                return cookieName.startsWith('d2_');
            });
            
            // Delete each D2 cookie
            d2Cookies.forEach(cookie => {
                const cookieName = cookie.trim().split('=')[0];
                document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;
                deletedCount++;
                console.log(`üóëÔ∏è Deleted cookie: ${cookieName}`);
            });
            
            // Also clear localStorage D2 data
            localStorage.removeItem('d2TestData');
            
            alert(`üóëÔ∏è ${deletedCount} D2-Test Cookies wurden gel√∂scht!\n\nLocalStorage wurde ebenfalls geleert.`);
            
            // Reload page to reflect changes
            if (confirm('Seite neu laden, um √Ñnderungen zu sehen?')) {
                window.location.reload();
            }
        }

        function saveCookieDataToFile() {
            try {
                // Get current user code for filename
                const userCodeInput = document.getElementById('userCode');
                const currentUserCode = userCodeInput ? userCodeInput.value.trim() : 'UnknownUser';
                
                // Create ISO date and time string (YYYY-MM-DD_HHMM)
                const now = new Date();
                const isoDate = now.toISOString().split('T')[0]; // Gets YYYY-MM-DD
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const timeString = `${hours}${minutes}`;
        
                // Create filename: ISO-Date_HHMM_D2Test_UserCode.json
                const filename = `${isoDate}_${timeString}_D2Test_${currentUserCode}.json`;
                
                // Collect all D2 cookie data
                const allCookies = document.cookie.split(';');
                const cookieData = {};
                let totalEntries = 0;
                
                allCookies.forEach(cookie => {
                    const [name, value] = cookie.trim().split('=');
                    if (name && name.startsWith('d2_')) {
                        try {
                            const decodedValue = decodeURIComponent(value || '');
                            const parsedData = JSON.parse(decodedValue);
                            cookieData[name] = parsedData;
                            totalEntries += Array.isArray(parsedData) ? parsedData.length : 1;
                        } catch (e) {
                            console.warn(`‚ö†Ô∏è Could not parse cookie ${name}:`, e);
                            cookieData[name] = { error: 'Could not parse', rawValue: value };
                        }
                    }
                });
                
                // Add localStorage data if available
                const localStorageData = localStorage.getItem('d2TestData');
                if (localStorageData) {
                    try {
                        cookieData['localStorage_d2TestData'] = JSON.parse(localStorageData);
                    } catch (e) {
                        cookieData['localStorage_d2TestData'] = { error: 'Could not parse', rawValue: localStorageData };
                    }
                }
                
                // Create export object with metadata
                const exportData = {
                    exportInfo: {
                        application: 'D2 Aufmerksamkeitstest',
                        exportDate: now.toISOString(),
                        userCode: currentUserCode,
                        totalCookieEntries: Object.keys(cookieData).length,
                        totalTestResults: totalEntries
                    },
                    cookieData: cookieData
                };
                
                // Convert to JSON string
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // Create and download file
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Clean up
                URL.revokeObjectURL(url);
                
                alert(`üíæ Cookie-Daten erfolgreich gespeichert!\n\nDatei: ${filename}\nSpeicherort: Downloads-Ordner\nEintr√§ge: ${totalEntries} Testergebnisse`);
                
            } catch (error) {
                console.error('‚ùå Error saving cookie data:', error);
                alert(`‚ùå Fehler beim Speichern der Cookie-Daten:\n${error.message}`);
            }
        }

    </script>
</body>
</html>