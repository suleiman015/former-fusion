<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D2 Aufmerksamkeitstest | AImpacts</title>
    <style>
        /*
         * ===== Modern Medical Theme Variables =====
         */
        :root {
          --primary: #0b6efd;         /* Calm diagnostic blue */
          --primary-dark: #0953c6;
          --accent: #198754;          /* subtle green accents */
          --danger: #d63384;          /* for incorrect/missed */
          --warning: #ffc107;
          --dark-text: #212529;
          --light-bg: #f5f7fa;
          --container-bg: #ffffff;
          --container-shadow: 0 8px 20px rgba(0,0,0,0.04);
          --radius: 8px;
        }

        /*
         * Global Styles and Utility Classes
         */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--light-bg);
            color: var(--dark-text);
            min-height: 100vh;
            padding: 24px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: var(--radius);
            box-shadow: var(--container-shadow);
            overflow: hidden;
        }

        /*
         * Header Section
         */
        .header {
            background: var(--container-bg);
            color: var(--primary);
            padding: 32px 24px;
            text-align: center;
            border-bottom: 4px solid var(--primary);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        /*
         * Setup Panel
         */
        .setup-panel {
            padding: 30px;
            background: #f8f9fa;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .instructions {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #2196F3;
        }

        .instructions h3 {
            color: #1976D2;
            margin-bottom: 10px;
        }

        .instructions ul {
            margin-left: 20px;
            list-style-type: disc;
        }

        .instructions li {
            margin-bottom: 5px;
        }

        /*
         * Buttons
         */
        .btn {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            margin: 8px;
            display: inline-block;
        }

        .btn:hover {
            background: var(--primary-dark);
            box-shadow: 0 4px 12px rgba(11,110,253,0.25);
        }

        .btn:disabled {
            background: #adb5bd;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /*
         * Test Area
         */
        .test-area {
            padding: 30px;
            display: none;
        }

        .test-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .timer {
            font-size: 1.5em;
            font-weight: bold;
            color: #ff6b6b;
        }

        .progress {
            font-size: 1.2em;
            color: #4CAF50;
        }

        .input-method {
            font-size: 0.9em;
            color: #666;
            background: #fff;
            padding: 5px 10px;
            border-radius: 15px;
        }

        .test-row {
            margin-bottom: 15px;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .row-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .row-number {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }

        .row-timer {
            font-size: 0.9em;
            color: #666;
        }

        .symbols {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: flex-start;
            align-items: flex-start;
            line-height: 0;
        }

        .symbol {
            position: relative;
            cursor: pointer;
            padding: 8px 5px;
            border-radius: 6px;
            transition: all 0.2s;
            user-select: none;
            min-width: 40px;
            height: 3.5em;
            text-align: center;
            border: 1px solid #ddd;
            font-family: 'Courier New', monospace;
            font-size: 1.5em;
            display: inline-flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            line-height: 1.1;
            vertical-align: top;
        }

        .symbol .base-char {
            z-index: 1;
            position: relative;
            line-height: 1;
        }

        .symbol .stroke-top,
        .symbol .stroke-bottom {
            position: absolute;
            font-size: 0.6em;
            line-height: 0.8;
            white-space: nowrap;
            z-index: 2;
            color: #333;
        }

        .symbol .stroke-top {
            top: 0.1em;
            left: 50%;
            transform: translateX(-50%);
        }

        .symbol .stroke-bottom {
            bottom: 0.1em;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .symbol.selected {
            background: #4CAF50;
            color: white;
            border-color: #45a049;
        }

        .symbol.correct {
            background: #4CAF50;
            color: white;
        }

        .symbol.incorrect {
            background: #f44336;
            color: white;
        }

        .symbol.missed {
            background: #ff9800;
            color: white;
        }

        /* Practice test feedback animations */
        .symbol.correct {
            background: linear-gradient(45deg, #4CAF50, #388E3C) !important;
            color: white !important;
            border-color: #388E3C !important;
            animation: correctPulse 0.5s ease-in-out;
        }

        .symbol.incorrect {
            background: linear-gradient(45deg, #f44336, #d32f2f) !important;
            color: white !important;
            border-color: #d32f2f !important;
            animation: incorrectShake 0.5s ease-in-out;
        }

        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /*
         * Results Section
         */
        .results {
            display: none;
            padding: 30px;
            text-align: center;
        }

        .score-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }

        .score-item {
            text-align: center;
        }

        .score-value {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }

        .score-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .chart-container {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .data-management {
            margin-top: 30px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 10px;
            border-left: 5px solid #ffc107;
        }

        /*
         * Responsive Adjustments
         */
        @media (max-width: 768px) {
            .symbols {
                font-size: 1.2em;
                gap: 5px;
            }
            
            .symbol {
                min-width: 30px;
                padding: 6px;
                font-size: 1.2em;
                height: 3em;
            }
            
            .test-controls {
                flex-direction: column;
                gap: 10px;
            }

            .score-card {
                flex-direction: column;
                gap: 10px;
            }

            .score-item {
                margin: 0;
            }
        }

        /*
         * Instruction Cards
         */
        .instruction-card, .rules-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 5px solid #4CAF50;
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-header .icon {
            font-size: 1.5em;
            margin-right: 12px;
        }

        .card-header h4 {
            margin: 0;
            color: #333;
            font-size: 1.3em;
        }

        /*
         * Examples Section
         */
        .examples-section {
            margin: 30px 0;
        }

        .examples-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .example-group {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .example-group.correct {
            border-left: 5px solid #4CAF50;
        }

        .example-group.incorrect {
            border-left: 5px solid #f44336;
        }

        .example-group h5 {
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            font-size: 1.1em;
        }

        .example-group h5 .icon {
            margin-right: 8px;
            font-size: 1.2em;
        }

        .symbol-examples {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /*
         * Practice Section
         */
        .practice-section {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
            border-radius: 12px;
            padding: 25px;
            margin: 30px 0;
            border-left: 5px solid #2196F3;
        }

        .practice-symbols {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .practice-controls {
            text-align: center;
            margin: 20px 0;
        }

        .practice-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }

        .practice-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .practice-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /*
         * Button Variants
         */
        .btn-secondary {
            background: #6c757d;
        }

        .btn-primary {
            background: var(--primary);
        }

        .btn:disabled {
            background: #adb5bd;
            color: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /*
         * Responsive Examples
         */
        @media (max-width: 768px) {
            .examples-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .practice-symbols {
                gap: 10px;
            }
            
            .symbol-examples {
                gap: 8px;
            }
        }

        /*
         * Feedback Messages
         */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 5px solid #f44336;
        }

        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 5px solid #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div id="debugModeIndicator" style="display: none; background: #ff6b6b; color: white; padding: 8px; text-align: center; font-weight: bold; border-radius: 5px; margin-bottom: 10px;">
                🔧 DEBUG MODE AKTIV
            </div>
            <h1>🧠 d2-Aufmerksamkeitstest</h1>
            <p>Konzentrations- und Aufmerksamkeitsmessung</p>
        </div>

        <div id="setupPanel" class="setup-panel">
            <div class="form-group">
                <label for="userCode">Ihr Code (z.B. Michael271274):</label>
                <input type="text" id="userCode" placeholder="Name + Geburtsdatum">
            </div>

            <div class="form-group">
                <label for="medication">Medikation:</label>
                <select id="medication">
                    <option value="ohne">Ohne Medikation</option>
                    <option value="mit">Mit Medikation</option>
                </select>
            </div>

            <div class="instructions">
                <h3>📋 D2-Aufmerksamkeitstest: Anleitung</h3>
                
                <div class="instruction-card">
                    <div class="card-header">
                        <span class="icon">🎯</span>
                        <h4>Ihre Aufgabe</h4>
                    </div>
                    <p>Markieren Sie <strong>alle "d" mit genau 2 Strichen/Punkten</strong> (oben und/oder unten).</p>
                    <p>Ein Strich (—) entspricht 2 Punkten (..) • Kombinationen sind möglich</p>
                </div>

                <div class="examples-section">
                    <div class="examples-grid">
                        <div class="example-group correct">
                            <h5><span class="icon">✓</span> RICHTIG - Markieren Sie diese:</h5>
                            <div class="symbol-examples" id="correctExamples"></div>
                        </div>
                        
                        <div class="example-group incorrect">
                            <h5><span class="icon">✗</span> FALSCH - Nicht markieren:</h5>
                            <div class="symbol-examples" id="incorrectExamples"></div>
                        </div>
                    </div>
                </div>

                <div class="practice-section">
                    <div class="card-header">
                        <span class="icon">🎓</span>
                        <h4>Übungstest</h4>
                    </div>
                    <p>Testen Sie Ihr Verständnis mit 5 Beispiel-Symbolen:</p>
                    <div id="practiceArea" class="practice-symbols"></div>
                    <div class="practice-controls">
                        <button class="btn btn-secondary" onclick="generatePractice()">Neue Übung</button>
                        <button class="btn btn-primary" onclick="checkPractice()" id="checkPracticeBtn" disabled>Lösung prüfen</button>
                    </div>
                    <div id="practiceResult" class="practice-result"></div>
                </div>

                <div class="rules-card">
                    <div class="card-header">
                        <span class="icon">⚡</span>
                        <h4>Testregeln</h4>
                    </div>
                    <ul>
                        <li><strong>Geschwindigkeit:</strong> 20 Sekunden pro Zeile (14 Zeilen)</li>
                        <li><strong>Eingabe:</strong> Maus, Finger oder Stift</li>
                        <li><strong>Feedback:</strong> Markierte Zeichen werden grün hervorgehoben</li>
                        <li><strong>Ziel:</strong> So schnell und genau wie möglich arbeiten</li>
                    </ul>
                </div>
            </div>

            <div style="text-align: center;">
                <button class="btn" onclick="startTest()">Test starten</button>
                <button class="btn" onclick="showResults()">Eigene Ergebnisse anzeigen</button>
                <button class="btn" onclick="deleteData()">Daten löschen</button>
                <button class="btn" onclick="importData()">📁 Daten importieren</button>
            </div>
            
            <!-- Debug Mode Buttons (only visible when debug=1 URL parameter is set) -->
            <div id="debugButtons" style="display: none; margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 10px; border-left: 5px solid #ffc107;">
                <h4>🔧 Debug-Modus aktiviert</h4>
                <p>Zusätzliche Funktionen für Entwicklung und Debugging:</p>
                <button class="btn btn-secondary" onclick="showCookieData()">🍪 Cookie-Daten anzeigen</button>
                <button class="btn btn-secondary" onclick="downloadCookieData()">📥 Cookie-Daten herunterladen</button>
                <button class="btn btn-secondary" onclick="showAllStorageData()">📊 Alle Speicherdaten anzeigen</button>
                <button class="btn btn-secondary" onclick="clearAllDebugData()">🗑️ Alle Debug-Daten löschen</button>
                <button class="btn btn-secondary" onclick="createTestData()" style="background: #2196F3; color: white;">🎯 Test-Daten erstellen</button>
                <button class="btn btn-secondary" onclick="testStorage()" style="background: #ff9800; color: white;">🔧 Speicher testen</button>
            </div>
        </div>

        <div id="testArea" class="test-area">
            <div class="test-controls">
                <div class="timer">⏱️ Zeit: <span id="timer">20</span>s</div>
                <div class="progress">📊 Zeile: <span id="currentRow">1</span>/14</div>
                <div class="input-method" id="inputMethod">🖱️ Maus</div>
            </div>
            <div id="testContent"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="nextRow()" id="nextBtn" disabled>Nächste Zeile</button>
                <button class="btn" onclick="finishTest()" id="finishBtn" style="display: none;">Test beenden</button>
            </div>
        </div>

        <div id="results" class="results">
            <h2>🎯 Testergebnisse</h2>
            <div id="scoreCard" class="score-card"></div>
            <div class="chart-container">
                <canvas id="progressChart" width="800" height="400"></canvas>
            </div>
            <div style="text-align: center;">
                <button class="btn" onclick="createTestData()">🎯 Dummy-Daten erstellen</button>
                <button class="btn" onclick="syncData()">🔄 Daten synchronisieren</button>
                <button class="btn" onclick="createFullBackup()">💾 Vollständiges Backup</button>
                <button class="btn" onclick="runComprehensiveStorageTest()">🧪 Speicher-Test</button>
            </div>

            <div class="data-management">
                <h3>📊 Datenverwaltung</h3>
                <p>Ihre Daten werden sicher in Cookies und LocalStorage des Browsers gespeichert und können zwischen Geräten übertragen werden.</p>
                
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #4CAF50;">
                    <h4 style="color: #2e7d32; margin-bottom: 10px;">💾 Speicherorte:</h4>
                    <ul style="margin-left: 20px; color: #2e7d32;">
                        <li><strong>Browser-Daten:</strong> Automatisch im lokalen Speicher</li>
                        <li><strong>Export-Dateien:</strong> Downloads-Ordner Ihres Computers</li>
                        <li><strong>Backup-Dateien:</strong> Downloads-Ordner (d2-test-backup-YYYY-MM-DD.json)</li>
                        <li><strong>Einzelexport:</strong> Downloads-Ordner (d2-test-BENUTZERNAME-YYYY-MM-DD.json)</li>
                    </ul>
                    <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        💡 <strong>Tipp:</strong> Sichern Sie regelmäßig Ihre Daten mit der Export-Funktion, 
                        um sie zwischen verschiedenen Geräten zu übertragen oder als Backup zu verwenden.
                    </p>
                </div>
                
                <div id="dataStatus"></div>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="syncData()">🔄 Daten synchronisieren</button>
                    <button class="btn" onclick="showStorageInfo()">ℹ️ Speicher-Info</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTest = {
            rows: [],
            currentRowIndex: 0,
            startTime: null,
            rowStartTime: null,
            results: [],
            userCode: '',
            medication: '',
            inputMethod: 'mouse',
            deviceInfo: getDeviceInfo()
        };

        let testData = [];
        let rowTimer = null;
        let testRunning = false;
        let practiceSymbols = [];
        let practiceSelections = [];

        // Check for debug mode
        function isDebugMode() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('debug') === '1';
        }

        // Initialize examples and practice on page load
        document.addEventListener('DOMContentLoaded', function() {
            generateExamples();
            generatePractice();
            currentTest.deviceInfo = getDeviceInfo();
            
            // Show debug buttons if debug mode is enabled
            console.log('🔍 Checking debug mode...', window.location.search);
            if (isDebugMode()) {
                console.log('✅ Debug mode detected!');
                
                // Show debug indicator in header
                const debugIndicator = document.getElementById('debugModeIndicator');
                if (debugIndicator) {
                    debugIndicator.style.display = 'block';
                }
                
                // Show debug buttons section
                const debugElement = document.getElementById('debugButtons');
                if (debugElement) {
                    debugElement.style.display = 'block';
                    console.log('🔧 Debug-Modus aktiviert! Debug-Sektion angezeigt.');
                } else {
                    console.error('❌ Debug-Element nicht gefunden!');
                }
            } else {
                console.log('❌ Debug mode NOT detected');
            }
            
            // Input method detection
            const deviceInfo = getDeviceInfo();
            let initialMethod = '🖱️ Maus';
            
            if (deviceInfo.isMobile) {
                initialMethod = '👆 Finger';
                currentTest.inputMethod = 'finger';
            } else if (deviceInfo.isTablet) {
                initialMethod = '✏️ Stift/Finger';
                currentTest.inputMethod = 'stylus/finger';
            }
            
            document.getElementById('inputMethod').innerHTML = initialMethod;
            
            document.addEventListener('touchstart', function() {
                currentTest.inputMethod = deviceInfo.isTablet ? 'stylus/finger' : 'finger';
                document.getElementById('inputMethod').innerHTML = deviceInfo.isTablet ? '✏️ Stift/Finger' : '👆 Finger';
            }, { passive: true });
            
            document.addEventListener('mousedown', function(e) {
                if (!e.sourceCapabilities || e.sourceCapabilities.firesTouchEvents === false) {
                    currentTest.inputMethod = 'mouse';
                    document.getElementById('inputMethod').innerHTML = '🖱️ Maus';
                }
            });
            
            if (window.PointerEvent) {
                document.addEventListener('pointerdown', function(e) {
                    if (e.pointerType === 'pen') {
                        currentTest.inputMethod = 'stylus';
                        document.getElementById('inputMethod').innerHTML = '✏️ Stift';
                    }
                });
            }
        });

        // Device and input detection
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            const isMobile = /iPhone|iPad|iPod|Android/i.test(ua);
            const isTablet = /iPad/i.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            
            return {
                isMobile: isMobile,
                isTablet: isTablet,
                isDesktop: !isMobile && !isTablet,
                userAgent: ua,
                touchSupport: 'ontouchstart' in window,
                platform: navigator.platform
            };
        }

        function detectInputMethod(event) {
            if (event.type.includes('touch')) {
                currentTest.inputMethod = currentTest.deviceInfo.isTablet ? 'stylus/finger' : 'finger';
                document.getElementById('inputMethod').innerHTML = currentTest.deviceInfo.isTablet ? '✏️ Stift/Finger' : '👆 Finger';
            } else if (event.type.includes('mouse')) {
                currentTest.inputMethod = 'mouse';
                document.getElementById('inputMethod').innerHTML = '🖱️ Maus';
            }
        }

        // Symbol generation and rendering logic
        function getRandomStrokeConfig(forTarget = false, targetValue = null) {
            const options = [
                { type: 'none', value: 0, char: '' },
                { type: 'dot', value: 1, char: '.' },
                { type: 'double_dot', value: 2, char: '..' },
                { type: 'bar', value: 2, char: '—' }
            ];

            if (forTarget && targetValue !== null) {
                const targetOptions = options.filter(opt => opt.value === targetValue);
                if (targetValue === 0) return options[0];
                if (targetValue === 1 && targetOptions.length === 0) return options.find(o => o.type === 'dot');
                
                if (targetOptions.length > 0) {
                    return targetOptions[Math.floor(Math.random() * targetOptions.length)];
                } else {
                    console.warn(`No suitable stroke config for target value ${targetValue}. Defaulting to none.`);
                    return options[0];
                }
            } else {
                return options[Math.floor(Math.random() * options.length)];
            }
        }

        function calculateEffectiveStrokes(topConfig, bottomConfig) {
            return topConfig.value + bottomConfig.value;
        }

        function generateSymbols(count = 47, minTargets = 3) {
            const symbols = [];
            const baseSymbols = ['d', 'b'];

            const targetCombinations = [
                { top: 2, bottom: 0 }, 
                { top: 0, bottom: 2 }, 
                { top: 1, bottom: 1 }  
            ];

            for (let i = 0; i < count; i++) {
                const base = baseSymbols[Math.floor(Math.random() * baseSymbols.length)];
                
                let topStrokeConfig, bottomStrokeConfig;
                let effectiveStrokes;
                let isTarget = false;

                topStrokeConfig = getRandomStrokeConfig();
                bottomStrokeConfig = getRandomStrokeConfig();
                effectiveStrokes = calculateEffectiveStrokes(topStrokeConfig, bottomStrokeConfig);
                isTarget = (base === 'd' && effectiveStrokes === 2);

                symbols.push({
                    base: base,
                    topStrokes: topStrokeConfig,
                    bottomStrokes: bottomStrokeConfig,
                    effectiveStrokes: effectiveStrokes,
                    isTarget: isTarget,
                    id: i
                });
            }

            let actualTargetsCount = symbols.filter(s => s.isTarget).length;
            while (actualTargetsCount < minTargets) {
                const nonTargetDs = symbols.filter(s => s.base === 'd' && !s.isTarget);
                if (nonTargetDs.length === 0) {
                    console.warn("Could not meet minimum target count for row (no more convertible 'd's).");
                    break;
                }

                const symbolToConvert = nonTargetDs[Math.floor(Math.random() * nonTargetDs.length)];
                
                const combo = targetCombinations[Math.floor(Math.random() * targetCombinations.length)];
                symbolToConvert.topStrokes = getRandomStrokeConfig(true, combo.top);
                symbolToConvert.bottomStrokes = getRandomStrokeConfig(true, combo.bottom);
                symbolToConvert.effectiveStrokes = calculateEffectiveStrokes(symbolToConvert.topStrokes, symbolToConvert.bottomStrokes);
                symbolToConvert.isTarget = true;
                actualTargetsCount++;
            }
            
            return symbols;
        }

        function renderSymbol(symbol) {
            const topStrokeHTML = symbol.topStrokes.char ? `<span class="stroke-top">${symbol.topStrokes.char}</span>` : '';
            const bottomStrokeHTML = symbol.bottomStrokes.char ? `<span class="stroke-bottom">${symbol.bottomStrokes.char}</span>` : '';
            
            return `
                <div class="symbol" data-id="${symbol.id}" onclick="selectSymbol(${symbol.id})" 
                    onmousedown="detectInputMethod(event)" ontouchstart="detectInputMethod(event)">
                    ${topStrokeHTML}
                    <span class="base-char">${symbol.base}</span>
                    ${bottomStrokeHTML}
                </div>
            `;
        }

        // Examples and Practice Functions
        function generateExamples() {
            // Correct examples (all d with exactly 2 strokes/points)
            const correctExamples = [
                { base: 'd', topStrokes: { char: '—', value: 2 }, bottomStrokes: { char: '', value: 0 }, isTarget: true, id: 'ex1' },
                { base: 'd', topStrokes: { char: '', value: 0 }, bottomStrokes: { char: '—', value: 2 }, isTarget: true, id: 'ex2' },
                { base: 'd', topStrokes: { char: '.', value: 1 }, bottomStrokes: { char: '.', value: 1 }, isTarget: true, id: 'ex3' },
                { base: 'd', topStrokes: { char: '..', value: 2 }, bottomStrokes: { char: '', value: 0 }, isTarget: true, id: 'ex4' }
            ];

            // Incorrect examples
            const incorrectExamples = [
                { base: 'b', topStrokes: { char: '', value: 0 }, bottomStrokes: { char: '', value: 0 }, isTarget: false, id: 'ex5' },
                { base: 'd', topStrokes: { char: '', value: 0 }, bottomStrokes: { char: '', value: 0 }, isTarget: false, id: 'ex6' },
                { base: 'd', topStrokes: { char: '.', value: 1 }, bottomStrokes: { char: '', value: 0 }, isTarget: false, id: 'ex7' },
                { base: 'd', topStrokes: { char: '—', value: 2 }, bottomStrokes: { char: '—', value: 2 }, isTarget: false, id: 'ex8' }
            ];

            document.getElementById('correctExamples').innerHTML = 
                correctExamples.map(symbol => renderExampleSymbol(symbol, true)).join('');
            
            document.getElementById('incorrectExamples').innerHTML = 
                incorrectExamples.map(symbol => renderExampleSymbol(symbol, false)).join('');
        }

        function renderExampleSymbol(symbol, isCorrect) {
            const topStrokeHTML = symbol.topStrokes.char ? `<span class="stroke-top">${symbol.topStrokes.char}</span>` : '';
            const bottomStrokeHTML = symbol.bottomStrokes.char ? `<span class="stroke-bottom">${symbol.bottomStrokes.char}</span>` : '';
            const bgColor = isCorrect ? '#4CAF50' : '#f44336';
            
            return `
                <div class="symbol" style="background: ${bgColor}; color: white; border-color: ${bgColor};">
                    ${topStrokeHTML}
                    <span class="base-char">${symbol.base}</span>
                    ${bottomStrokeHTML}
                </div>
            `;
        }

        function generatePractice() {
            practiceSymbols = [];
            practiceSelections = [];
            
            // Generate 5 practice symbols with mix of targets and non-targets
            const practiceConfigs = [
                { base: 'd', top: 2, bottom: 0, isTarget: true },
                { base: 'b', top: 0, bottom: 0, isTarget: false },
                { base: 'd', top: 0, bottom: 0, isTarget: false },
                { base: 'd', top: 1, bottom: 1, isTarget: true },
                { base: 'd', top: 1, bottom: 0, isTarget: false }
            ];

            // Shuffle the array
            for (let i = practiceConfigs.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [practiceConfigs[i], practiceConfigs[j]] = [practiceConfigs[j], practiceConfigs[i]];
            }

            practiceConfigs.forEach((config, index) => {
                const topConfig = getRandomStrokeConfig(true, config.top);
                const bottomConfig = getRandomStrokeConfig(true, config.bottom);
                
                practiceSymbols.push({
                    base: config.base,
                    topStrokes: topConfig,
                    bottomStrokes: bottomConfig,
                    isTarget: config.isTarget,
                    id: index,
                    selected: false
                });
                practiceSelections.push(false);
            });

            renderPractice();
        }

        function renderPractice() {
            const practiceHtml = practiceSymbols.map((symbol, index) => {
                const topStrokeHTML = symbol.topStrokes.char ? `<span class="stroke-top">${symbol.topStrokes.char}</span>` : '';
                const bottomStrokeHTML = symbol.bottomStrokes.char ? `<span class="stroke-bottom">${symbol.bottomStrokes.char}</span>` : '';
                const selectedClass = practiceSelections[index] ? 'selected' : '';
                
                return `
                    <div class="symbol ${selectedClass}" onclick="togglePracticeSymbol(${index})">
                        ${topStrokeHTML}
                        <span class="base-char">${symbol.base}</span>
                        ${bottomStrokeHTML}
                    </div>
                `;
            }).join('');

            document.getElementById('practiceArea').innerHTML = practiceHtml;
            document.getElementById('checkPracticeBtn').disabled = false;
            document.getElementById('practiceResult').innerHTML = '';
            document.getElementById('practiceResult').className = 'practice-result';
        }

        function togglePracticeSymbol(index) {
            practiceSelections[index] = !practiceSelections[index];
            const symbolElement = document.getElementById('practiceArea').children[index];
            
            if (practiceSelections[index]) {
                symbolElement.classList.add('selected');
            } else {
                symbolElement.classList.remove('selected');
            }
        }

        function checkPractice() {
            let correct = 0;
            let total = practiceSymbols.length;
            let errors = [];

            practiceSymbols.forEach((symbol, index) => {
                const shouldBeSelected = symbol.isTarget;
                const wasSelected = practiceSelections[index];
                
                if (shouldBeSelected === wasSelected) {
                    correct++;
                } else {
                    if (shouldBeSelected && !wasSelected) {
                        errors.push(`Symbol ${index + 1}: Sollte markiert werden (${symbol.base} mit ${symbol.topStrokes.value + symbol.bottomStrokes.value} Strichen)`);
                    } else {
                        errors.push(`Symbol ${index + 1}: Sollte NICHT markiert werden (${symbol.base} mit ${symbol.topStrokes.value + symbol.bottomStrokes.value} Strichen)`);
                    }
                }
            });

            const resultDiv = document.getElementById('practiceResult');
            
            if (correct === total) {
                resultDiv.className = 'practice-result success';
                resultDiv.innerHTML = `🎉 Perfekt! ${correct}/${total} richtig. Sie haben das Prinzip verstanden!`;
            } else {
                resultDiv.className = 'practice-result error';
                resultDiv.innerHTML = `
                    ❌ ${correct}/${total} richtig. Bitte beachten Sie:<br>
                    <small>${errors.join('<br>')}</small><br><br>
                    💡 <strong>Merksatz:</strong> Nur "d" mit genau 2 Strichen/Punkten markieren!
                `;
            }

            // Show correct answers visually
            practiceSymbols.forEach((symbol, index) => {
                const symbolElement = document.getElementById('practiceArea').children[index];
                symbolElement.classList.remove('selected');
                
                if (symbol.isTarget) {
                    symbolElement.classList.add('correct');
                } else if (practiceSelections[index]) {
                    symbolElement.classList.add('incorrect');
                }
            });

            document.getElementById('checkPracticeBtn').disabled = true;
        }

        function generateTestRows() {
            const rows = [];
            for (let i = 0; i < 14; i++) {
                rows.push(generateSymbols(47));
            }
            return rows;
        }

        function startTest() {
            const userCode = document.getElementById('userCode').value.trim();
            if (!userCode) {
                alert('Bitte geben Sie Ihren Code ein!');
                return;
            }

            currentTest.userCode = userCode;
            currentTest.medication = document.getElementById('medication').value;
            currentTest.rows = generateTestRows();
            currentTest.startTime = new Date();
            currentTest.results = [];
            currentTest.currentRowIndex = 0;
            testRunning = true;

            document.getElementById('setupPanel').style.display = 'none';
            document.getElementById('testArea').style.display = 'block';
            
            renderCurrentRow();
            startRowTimer();
        }

        function renderCurrentRow() {
            const row = currentTest.rows[currentTest.currentRowIndex];
            const rowNumber = currentTest.currentRowIndex + 1;
            
            const symbolsHtml = row.map(symbol => renderSymbol(symbol)).join('');
            
            document.getElementById('testContent').innerHTML = `
                <div class="test-row">
                    <div class="row-header">
                        <span class="row-number">Zeile ${rowNumber}</span>
                        <span class="row-timer" id="rowTimer">Zeit: 20s</span>
                    </div>
                    <div class="symbols">${symbolsHtml}</div>
                </div>
            `;
            
            document.getElementById('currentRow').textContent = rowNumber;
            document.getElementById('nextBtn').disabled = false;
            
            if (currentTest.currentRowIndex === currentTest.rows.length - 1) {
                document.getElementById('nextBtn').style.display = 'none';
                document.getElementById('finishBtn').style.display = 'inline-block';
            } else {
                document.getElementById('nextBtn').style.display = 'inline-block';
                document.getElementById('finishBtn').style.display = 'none';
            }

            document.querySelectorAll('.symbol').forEach((symbolEl, idx) => {
                symbolEl.setAttribute('role', 'button');
                symbolEl.setAttribute('aria-label', `Symbol ${idx + 1} (${symbolEl.textContent.trim()})`);
                symbolEl.setAttribute('tabindex', '0');
            });
        }

        function selectSymbol(symbolId) {
            if (!testRunning) return;
            
            const symbol = currentTest.rows[currentTest.currentRowIndex][symbolId];
            const symbolElement = document.querySelector(`[data-id="${symbolId}"]`);
            
            if (!symbolElement) {
                console.error('Symbol element not found for ID:', symbolId);
                return;
            }

            if (symbol.selected) {
                symbol.selected = false;
                symbolElement.classList.remove('selected');
            } else {
                symbol.selected = true;
                symbolElement.classList.add('selected');
            }
        }

        function startRowTimer() {
            currentTest.rowStartTime = new Date();
            let timeLeft = 20;
            document.getElementById('timer').textContent = timeLeft;
            
            rowTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;
                document.getElementById('rowTimer').textContent = `Zeit: ${timeLeft}s`;
                
                if (timeLeft <= 0) {
                    clearInterval(rowTimer);
                    nextRow();
                }
            }, 1000);
        }

        function nextRow() {
            if (!testRunning) return;
            
            clearInterval(rowTimer);
            
            const row = currentTest.rows[currentTest.currentRowIndex];
            const rowResult = calculateRowResult(row);
            currentTest.results.push(rowResult);
            
            showRowFeedback(row);
            
            setTimeout(() => {
                currentTest.currentRowIndex++;
                
                if (currentTest.currentRowIndex < currentTest.rows.length) {
                    renderCurrentRow();
                    startRowTimer();
                } else {
                    finishTest();
                }
            }, 2000);
        }

        function calculateRowResult(row) {
            let correct = 0;
            let incorrect = 0;
            let missed = 0;
            let totalTargets = 0;
            
            row.forEach(symbol => {
                if (symbol.isTarget) {
                    totalTargets++;
                    if (symbol.selected) {
                        correct++;
                    } else {
                        missed++;
                    }
                } else if (symbol.selected) {
                    incorrect++;
                }
            });
            
            const timeSpent = (new Date() - currentTest.rowStartTime) / 1000;
            
            return {
                rowNumber: currentTest.currentRowIndex + 1,
                correct: correct,
                incorrect: incorrect,
                missed: missed,
                totalTargets: totalTargets,
                timeSpent: Math.round(timeSpent),
                processed: correct + incorrect,
                accuracy: totalTargets > 0 ? (correct / totalTargets * 100).toFixed(1) : 0
            };
        }

        function showRowFeedback(row) {
            row.forEach((symbol, index) => {
                const element = document.querySelector(`[data-id="${index}"]`);
                if (element) {
                    if (symbol.isTarget && symbol.selected) {
                        element.classList.add('correct');
                    } else if (symbol.isTarget && !symbol.selected) {
                        element.classList.add('missed');
                    } else if (!symbol.isTarget && symbol.selected) {
                        element.classList.add('incorrect');
                    }
                }
            });
            
            document.getElementById('nextBtn').disabled = true;
        }

        function finishTest() {
            testRunning = false;
            clearInterval(rowTimer);
            
            const totalResult = calculateTotalResult();
            
            console.log('=== SAVING TEST RESULT ===');
            console.log('Result to save:', totalResult);
            
            saveTestResult(totalResult);
            
            document.getElementById('testArea').style.display = 'none';
            document.getElementById('results').style.display = 'block';
            
            displayResults(totalResult);
        }

        function calculateTotalResult() {
            const totalCorrect = currentTest.results.reduce((sum, row) => sum + row.correct, 0);
            const totalIncorrect = currentTest.results.reduce((sum, row) => sum + row.incorrect, 0);
            const totalMissed = currentTest.results.reduce((sum, row) => sum + row.missed, 0);
            const totalTargets = currentTest.results.reduce((sum, row) => sum + row.totalTargets, 0);
            const totalProcessed = currentTest.results.reduce((sum, row) => sum + row.processed, 0);
            const totalTime = (new Date() - currentTest.startTime) / 1000;
            
            const overallAccuracy = totalTargets > 0 ? (totalCorrect / totalTargets * 100).toFixed(1) : 0;
            const processingSpeed = (totalProcessed / (totalTime / 60)).toFixed(1);
            
            return {
                timestamp: new Date().toISOString(),
                userCode: currentTest.userCode,
                medication: currentTest.medication,
                inputMethod: currentTest.inputMethod,
                deviceInfo: currentTest.deviceInfo,
                totalCorrect: totalCorrect,
                totalIncorrect: totalIncorrect,
                totalMissed: totalMissed,
                totalTargets: totalTargets,
                totalProcessed: totalProcessed,
                totalTime: Math.round(totalTime),
                overallAccuracy: parseFloat(overallAccuracy),
                processingSpeed: parseFloat(processingSpeed),
                rowResults: currentTest.results,
                concentrationIndex: calculateConcentrationIndex(),
                errorRate: totalProcessed > 0 ? (totalIncorrect / totalProcessed * 100).toFixed(1) : 0
            };
        }

        function calculateConcentrationIndex() {
            const totalCorrect = currentTest.results.reduce((sum, row) => sum + row.correct, 0);
            const totalIncorrect = currentTest.results.reduce((sum, row) => sum + row.incorrect, 0);
            return totalCorrect - totalIncorrect;
        }

        function saveTestResult(result) {
            console.log('=== SAVETESTRESULT CALLED ===');
            console.log('Saving result for user:', result.userCode);
            
            let saveSuccess = false;
            
            try {
                let localData = JSON.parse(localStorage.getItem('d2TestData') || '[]');
                console.log('Current localStorage data:', localData.length, 'entries');
                
                localData.push(result);
                localStorage.setItem('d2TestData', JSON.stringify(localData));
                
                console.log('✅ LocalStorage saved successfully. New total:', localData.length);
                saveSuccess = true;
            } catch (e) {
                console.error('❌ LocalStorage save failed:', e);
            }
            
            try {
                const cookieName = `d2_${result.userCode}`;
                let cookieData = getCookieData(cookieName);
                cookieData.push(result);
                
                if (cookieData.length > 5) {
                    cookieData = cookieData.slice(-5);
                }
                
                const cookieValue = JSON.stringify(cookieData);
                const expiryDate = new Date();
                expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                
                document.cookie = `${cookieName}=${encodeURIComponent(cookieValue)}; expires=${expiryDate.toUTCString()}; path=/; SameSite=Lax`;
                
                console.log('✅ Cookie saved successfully for:', result.userCode);
                saveSuccess = true;
            } catch (e) {
                console.error('❌ Cookie save failed:', e);
            }
            
            const statusDiv = document.getElementById('dataStatus');
            if (statusDiv) {
                if (saveSuccess) {
                    statusDiv.innerHTML = `
                        <div class="success">✅ Testergebnis erfolgreich gespeichert!<br>
                        Code: ${result.userCode}<br>
                        Medikation: ${result.medication}<br>
                        Genauigkeit: ${result.overallAccuracy}%</div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="error">❌ Speichern fehlgeschlagen! Bitte versuchen Sie es erneut.</div>
                    `;
                }
            }
            
            console.log('=== SAVE COMPLETE ===');
            return saveSuccess;
        }

        function getCookieData(cookieName) {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === cookieName && value) {
                    try {
                        const decoded = decodeURIComponent(value);
                        return JSON.parse(decoded);
                    } catch (e) {
                        console.error('Cookie parsing failed for', cookieName, ':', e);
                        return [];
                    }
                }
            }
            return [];
        }

        function loadFromCookies(userCode) {
            const cookieName = `d2_${userCode}`;
            const data = getCookieData(cookieName);
            console.log('Loaded from cookies for', userCode, ':', data.length, 'results');
            return data;
        }

        function displayResults(result) {
            document.getElementById('scoreCard').innerHTML = `
                <div class="score-item">
                    <span class="score-value">${result.totalCorrect}</span>
                    <span class="score-label">Richtige Treffer</span>
                </div>
                <div class="score-item">
                    <span class="score-value">${result.totalIncorrect}</span>
                    <span class="score-label">Fehler</span>
                </div>
                <div class="score-item">
                    <span class="score-value">${result.overallAccuracy}%</span>
                    <span class="score-label">Genauigkeit</span>
                </div>
                <div class="score-item">
                    <span class="score-value">${result.processingSpeed}</span>
                    <span class="score-label">Items/Min</span>
                </div>
                <div class="score-item">
                    <span class="score-value">${result.concentrationIndex}</span>
                    <span class="score-label">Konzentrations-Index</span>
                </div>
                <div class="score-item">
                    <span class="score-value">${result.inputMethod}</span>
                    <span class="score-label">Eingabemethode</span>
                </div>
            `;
            
            drawProgressChart(result);
        }

        function drawProgressChart(result) {
            const canvas = document.getElementById('progressChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const margin = 60;
            const chartWidth = canvas.width - 2 * margin;
            const chartHeight = canvas.height - 2 * margin;
            
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, margin + chartHeight);
            ctx.lineTo(margin + chartWidth, margin + chartHeight);
            ctx.stroke();
            
            ctx.fillStyle = '#333';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Leistung pro Zeile', canvas.width / 2, 30);
            
            const maxAccuracy = 100;
            const rowWidth = chartWidth / result.rowResults.length;
            
            result.rowResults.forEach((row, i) => {
                const x = margin + i * rowWidth + rowWidth / 2;
                const accuracy = parseFloat(row.accuracy);
                const barHeight = (accuracy / maxAccuracy) * chartHeight;
                const y = margin + chartHeight - barHeight;
                
                ctx.fillStyle = accuracy >= 80 ? '#4CAF50' : accuracy >= 60 ? '#ff9800' : '#f44336';
                ctx.fillRect(x - rowWidth / 3, y, rowWidth * 2/3, barHeight);
                
                ctx.fillStyle = '#333';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${accuracy}%`, x, y - 5);
                
                ctx.fillText(`${i + 1}`, x, margin + chartHeight + 15);
            });
            
            ctx.fillStyle = '#666';
            ctx.font = '12px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('Zeile', margin, margin + chartHeight + 35);
            ctx.textAlign = 'center';
            ctx.fillText('Genauigkeit (%)', margin - 35, margin + chartHeight / 2);
        }

        function showResults() {
            const userCode = document.getElementById('userCode').value.trim();
            if (!userCode) {
                alert('Bitte geben Sie Ihren Code ein!');
                return;
            }
            
            console.log('=== LOADING RESULTS FOR:', userCode, '===');
            
            let localData = [];
            try {
                localData = JSON.parse(localStorage.getItem('d2TestData') || '[]');
                console.log('Loaded from localStorage:', localData.length, 'total entries');
            } catch (e) {
                console.error('LocalStorage load failed:', e);
            }
            
            let cookieData = [];
            try {
                cookieData = loadFromCookies(userCode);
                console.log('Loaded from cookies:', cookieData.length, 'entries for user');
            } catch (e) {
                console.error('Cookie load failed:', e);
            }
            
            const allData = [...localData, ...cookieData];
            const userData = allData
                .filter(result => result.userCode === userCode)
                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
                .filter((item, index, arr) => 
                    index === arr.findIndex(t => t.timestamp === item.timestamp)
                );
            
            console.log('Final filtered data for user:', userData.length, 'entries');
            
            if (userData.length === 0) {
                alert(`Keine Daten für Code "${userCode}" gefunden!\n\nTipp: Stellen Sie sicher, dass Sie mindestens einen Test abgeschlossen haben.`);
                return;
            }
            
            document.getElementById('setupPanel').style.display = 'none';
            document.getElementById('results').style.display = 'block';
            
            const latestResult = userData[userData.length - 1];
            displayResults(latestResult);
            
            const stats = calculateTestStatistics(userData);
            document.getElementById('dataStatus').innerHTML = `
                <h4>📈 Ihre bisherigen Tests (${userData.length} Durchgänge):</h4>
                ${stats ? `
                <div style="background: white; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <strong>📊 Statistik:</strong><br>
                    🟢 Mit Medikation: ${stats.testsWithMedication} Tests (Ø ${stats.avgAccuracyWith}% Genauigkeit)<br>
                    🔵 Ohne Medikation: ${stats.testsWithoutMedication} Tests (Ø ${stats.avgAccuracyWithout}% Genauigkeit)<br>
                    ${stats.improvement > 0 ? `✅ Verbesserung: +${stats.improvement}%` : 
                    stats.improvement < 0 ? `❌ Verschlechterung: ${stats.improvement}%` : '➖ Keine Änderung'}
                </div>
                ` : ''}
                <div style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
                    ${userData.map((result, i) => `
                        <div style="padding: 10px; margin: 5px 0; background: white; border-radius: 5px; border-left: 4px solid ${result.medication === 'mit' ? '#4CAF50' : '#2196F3'};">
                            <strong>Test ${i + 1}</strong> (${new Date(result.timestamp).toLocaleDateString('de-DE', {
                                year: 'numeric', month: '2-digit', day: '2-digit', 
                                hour: '2-digit', minute: '2-digit'
                            })})
                            - ${result.medication === 'mit' ? '💊 Mit' : '🚫 Ohne'} Medikation
                            - ${result.overallAccuracy}% Genauigkeit
                            - ${result.inputMethod}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function deleteData() {
            const userCode = document.getElementById('userCode').value.trim();
            if (!userCode) {
                alert('Bitte geben Sie Ihren Code ein!');
                return;
            }
            
            if (confirm(`Alle Daten für Code "${userCode}" wirklich löschen?`)) {
                let localData = JSON.parse(localStorage.getItem('d2TestData') || '[]');
                localData = localData.filter(result => result.userCode !== userCode);
                localStorage.setItem('d2TestData', JSON.stringify(localData));
                
                const cookieName = `d2_${userCode}`;
                document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
                
                alert('Daten wurden gelöscht!');
                document.getElementById('dataStatus').innerHTML = `
                    <div class="success">✅ Alle Daten für "${userCode}" wurden aus Cookies und LocalStorage gelöscht!</div>
                `;
            }
        }

        function exportData() {
            const userCode = document.getElementById('userCode').value.trim() || currentTest.userCode;
            if (!userCode) {
                alert('Bitte geben Sie einen Code ein!');
                return;
            }
            
            console.log('=== EXPORT DATA FOR:', userCode, '===');
            
            let localData = [];
            try {
                localData = JSON.parse(localStorage.getItem('d2TestData') || '[]');
                console.log('LocalStorage total entries:', localData.length);
            } catch (e) {
                console.error('LocalStorage load error:', e);
            }
            
            let cookieData = [];
            try {
                cookieData = loadFromCookies(userCode);
                console.log('Cookie entries for user:', cookieData.length);
            } catch (e) {
                console.error('Cookie load error:', e);
            }
            
            const localUserData = localData.filter(result => result.userCode === userCode);
            console.log('LocalStorage entries for', userCode + ':', localUserData.length);
            
            const allData = [...localUserData, ...cookieData];
            const userData = allData
                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
                .filter((item, index, arr) => 
                    index === arr.findIndex(t => t.timestamp === item.timestamp)
                );
            
            console.log('Final merged data for export:', userData.length);
            
            if (userData.length === 0) {
                const debugInfo = `
Keine Daten für "${userCode}" gefunden!

Debug-Info:
• LocalStorage Gesamt: ${localData.length} Einträge
• LocalStorage für User: ${localUserData.length} Einträge  
• Cookies für User: ${cookieData.length} Einträge
• Verfügbare User-Codes: ${[...new Set(localData.map(r => r.userCode))].join(', ') || 'keine'}

Tipp: 
1. Führen Sie zuerst einen Test durch
2. Oder verwenden Sie "🔧 Speicher testen" um Test-Daten zu erstellen
3. Oder importieren Sie eine vorhandene Datei
                `;
                
                alert(debugInfo);
                return;
            }
            
            const exportData = {
                userCode: userCode,
                exportDate: new Date().toISOString(),
                testCount: userData.length,
                version: '1.0',
                results: userData,
                statistics: calculateTestStatistics(userData),
                exportSource: 'localStorage+cookies'
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            const isoDate = new Date().toISOString().split('T')[0];
            a.href = url;
            a.download = `d2-test-${userCode}-${isoDate}.json`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`✅ ${userData.length} Tests exportiert als: d2-test-${userCode}-${isoDate}.json`);
            console.log('=== EXPORT COMPLETED ===');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (!importedData.userCode || !importedData.results || !Array.isArray(importedData.results)) {
                            throw new Error('Ungültiges Datenformat');
                        }
                        
                        let localData = JSON.parse(localStorage.getItem('d2TestData') || '[]');
                        
                        localData = localData.filter(result => result.userCode !== importedData.userCode);
                        
                        localData.push(...importedData.results);
                        
                        localStorage.setItem('d2TestData', JSON.stringify(localData));
                        
                        importedData.results.forEach(result => {
                            saveToCookies(result);
                        });
                        
                        alert(`✅ ${importedData.results.length} Tests für "${importedData.userCode}" erfolgreich importiert!`);
                        
                        document.getElementById('userCode').value = importedData.userCode;
                        
                        document.getElementById('dataStatus').innerHTML = `
                            <div class="success">
                                ✅ Import erfolgreich!<br>
                                ${importedData.results.length} Tests für "${importedData.userCode}" wurden importiert.<br>
                                Exportdatum: ${new Date(importedData.exportDate).toLocaleDateString('de-DE')}
                            </div>
                        `;
                        
                    } catch (error) {
                        alert('❌ Fehler beim Importieren: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function saveToCookies(result) {
            const cookieName = `d2_${result.userCode}`;
            let existingData = getCookieData(cookieName);
            existingData.push(result);
            
            if (existingData.length > 10) {
                existingData = existingData.slice(-10);
            }
            
            try {
                const cookieValue = encodeURIComponent(JSON.stringify(existingData));
                const expiryDate = new Date();
                expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                
                document.cookie = `${cookieName}=${cookieValue}; expires=${expiryDate.toUTCString()}; path=/; SameSite=Lax`;
                console.log('Cookie saved successfully for', result.userCode);
            } catch (e) {
                console.error('Cookie save failed:', e);
                try {
                    const singleResult = encodeURIComponent(JSON.stringify([result]));
                    document.cookie = `${cookieName}=${singleResult}; expires=${expiryDate.toUTCString()}; path=/; SameSite=Lax`;
                } catch (e2) {
                    console.error('Even single result cookie failed:', e2);
                }
            }
        }

        function resetTest() {
            document.getElementById('results').style.display = 'none';
            document.getElementById('setupPanel').style.display = 'block';
            
            currentTest = {
                rows: [],
                currentRowIndex: 0,
                startTime: null,
                rowStartTime: null,
                results: [],
                userCode: '',
                medication: '',
                inputMethod: 'mouse',
                deviceInfo: getDeviceInfo()
            };
            
            clearInterval(rowTimer);
            testRunning = false;

            document.getElementById('nextBtn').style.display = 'inline-block';
            document.getElementById('finishBtn').style.display = 'none';
        }

        function calculateTestStatistics(userData) {
            if (!userData || userData.length === 0) return null;
            
            const withMedication = userData.filter(r => r.medication === 'mit');
            const withoutMedication = userData.filter(r => r.medication === 'ohne');
            
            const avgAccuracyWith = withMedication.length > 0 ? 
                withMedication.reduce((sum, r) => sum + r.overallAccuracy, 0) / withMedication.length : 0;
            const avgAccuracyWithout = withoutMedication.length > 0 ? 
                withoutMedication.reduce((sum, r) => sum + r.overallAccuracy, 0) / withoutMedication.length : 0;
            
            return {
                totalTests: userData.length,
                testsWithMedication: withMedication.length,
                testsWithoutMedication: withoutMedication.length,
                avgAccuracyWith: avgAccuracyWith.toFixed(1),
                avgAccuracyWithout: avgAccuracyWithout.toFixed(1),
                improvement: (avgAccuracyWith - avgAccuracyWithout).toFixed(1),
                latestTest: userData[userData.length - 1]
            };
        }

        function testStorage() {
            console.log('=== COMPREHENSIVE STORAGE TEST ===');
            
            localStorage.removeItem('d2TestData');
            document.cookie.split(";").forEach(function(c) { 
                const cookieName = c.trim().split("=")[0];
                if (cookieName.startsWith('d2_')) {
                    document.cookie = cookieName + '=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/'; 
                }
            });
            
            let statusMessages = [];

            try {
                localStorage.setItem('test', 'works');
                const localTest = localStorage.getItem('test');
                if (localTest === 'works') {
                    statusMessages.push('✅ LocalStorage basic test: OK');
                } else {
                    statusMessages.push('❌ LocalStorage basic test: FAILED');
                }
                localStorage.removeItem('test');
                
                const testResultLS = {
                    userCode: 'TEST123LS',
                    timestamp: new Date().toISOString(),
                    medication: 'ohne',
                    totalCorrect: 42,
                    overallAccuracy: 85.5
                };
                
                localStorage.setItem('d2TestData', JSON.stringify([testResultLS]));
                const retrievedLS = JSON.parse(localStorage.getItem('d2TestData') || '[]');
                if (retrievedLS.length === 1 && retrievedLS[0].userCode === 'TEST123LS') {
                    statusMessages.push('✅ LocalStorage d2 data test: OK');
                } else {
                    statusMessages.push('❌ LocalStorage d2 data test: FAILED');
                }
                
            } catch (e) {
                statusMessages.push(`❌ LocalStorage test: FAILED - ${e.message}`);
            }
            
            try {
                document.cookie = 'testcookie=works; path=/';
                const cookieTest = document.cookie.includes('testcookie=works');
                if (cookieTest) {
                    statusMessages.push('✅ Cookie basic test: OK');
                } else {
                    statusMessages.push('❌ Cookie basic test: FAILED');
                }
                document.cookie = 'testcookie=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/';
                
                const testCookieData = [{userCode: 'TEST123C', score: 42, timestamp: new Date().toISOString()}];
                const cookieValue = encodeURIComponent(JSON.stringify(testCookieData));
                document.cookie = `d2_TEST123C=${cookieValue}; path=/; max-age=${365 * 24 * 60 * 60}`;
                
                const cookieRetrieved = getCookieData('d2_TEST123C');
                if (cookieRetrieved.length === 1 && cookieRetrieved[0].userCode === 'TEST123C') {
                    statusMessages.push('✅ Cookie d2 data test: OK');
                } else {
                    statusMessages.push('❌ Cookie d2 data test: FAILED');
                }
                
            } catch (e) {
                statusMessages.push(`❌ Cookie test: FAILED - ${e.message}`);
            }
            
            try {
                const testUser = 'Michael271274';
                const fullTestResult = {
                    userCode: testUser,
                    timestamp: new Date().toISOString(),
                    medication: 'mit',
                    inputMethod: 'mouse',
                    deviceInfo: getDeviceInfo(),
                    totalCorrect: 35,
                    totalIncorrect: 3,
                    overallAccuracy: 92.1,
                    processingSpeed: 15.5,
                    concentrationIndex: 32,
                    rowResults: [{rowNumber: 1, correct: 3, incorrect: 0}]
                };
                
                const saveResult = saveTestResult(fullTestResult);
                if (saveResult) {
                    statusMessages.push('✅ Full save cycle: OK');
                } else {
                    statusMessages.push('❌ Full save cycle: FAILED');
                }
                
                document.getElementById('userCode').value = testUser;
                let loadedData = JSON.parse(localStorage.getItem('d2TestData') || '[]');
                let loadedCookieData = loadFromCookies(testUser);
                const allLoadedData = [...loadedData, ...loadedCookieData];
                const userResults = allLoadedData.filter(r => r.userCode === testUser);

                if (userResults.length > 0) {
                    statusMessages.push('✅ Full load cycle: OK (found ' + userResults.length + ' results for ' + testUser + ')');
                } else {
                    statusMessages.push('❌ Full load cycle: FAILED (no results found for ' + testUser + ')');
                }
                
            } catch (e) {
                statusMessages.push(`❌ Full cycle test: FAILED - ${e.message}`);
            }
            
            const currentLocal = JSON.parse(localStorage.getItem('d2TestData') || '[]');
            const currentCookiesCount = document.cookie.split(';').filter(c => c.trim().startsWith('d2_')).length;
            
            statusMessages.push(`Current state:`);
            statusMessages.push(`- LocalStorage entries: ${currentLocal.length}`);
            statusMessages.push(`- Cookie entries for d2 users: ${currentCookiesCount}`);
            
            const statusElement = document.getElementById('dataStatus');
            if (statusElement) {
                statusElement.innerHTML = `
                    <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin: 10px 0; font-family: monospace;">
                        <h4>🔧 Speicher-Test Ergebnisse:</h4>
                        ${statusMessages.map(msg => `<p>${msg}</p>`).join('')}
                        <p>📊 Test-User "Michael271274" wurde erstellt und gespeichert.</p>
                        <p><strong>➡️ Sie können jetzt "Eigene Ergebnisse anzeigen" testen!</strong></p>
                    </div>
                `;
            }
            
            console.log('=== END COMPREHENSIVE STORAGE TEST ===');
            alert('✅ Speicher-Test abgeschlossen! Schauen Sie in die Browser-Konsole (F12) für Details.');
        }

        function createTestData() {
            const dummyUserCode = document.getElementById('userCode').value.trim() || 'DummyUser' + Math.floor(Math.random() * 1000);
            const dummyMedication = ['ohne', 'mit'][Math.floor(Math.random() * 2)];
            
            currentTest.userCode = dummyUserCode;
            currentTest.medication = dummyMedication;
            currentTest.deviceInfo = getDeviceInfo();
            currentTest.inputMethod = 'mouse';

            const dummyResults = [];
            for (let i = 0; i < 14; i++) {
                dummyResults.push({
                    rowNumber: i + 1,
                    correct: Math.floor(Math.random() * 20) + 20,
                    incorrect: Math.floor(Math.random() * 5),
                    missed: Math.floor(Math.random() * 5),
                    totalTargets: 47,
                    timeSpent: Math.floor(Math.random() * 5) + 15,
                    processed: Math.floor(Math.random() * 40) + 5,
                    accuracy: (Math.random() * 40 + 60).toFixed(1)
                });
            }

            currentTest.results = dummyResults;
            currentTest.startTime = new Date(Date.now() - (14 * 20 * 1000));

            const totalResult = calculateTotalResult();
            saveTestResult(totalResult);

            alert(`🎯 Dummy-Daten für "${dummyUserCode}" erstellt und gespeichert. Sie können jetzt "Eigene Ergebnisse anzeigen" verwenden.`);
            document.getElementById('userCode').value = dummyUserCode;
            document.getElementById('medication').value = dummyMedication;
        }

        function syncData() {
            const userCode = document.getElementById('userCode').value.trim();
            if (!userCode) {
                alert('Bitte geben Sie Ihren Code ein!');
                return;
            }
            
            const localData = JSON.parse(localStorage.getItem('d2TestData') || '[]');
            const cookieData = loadFromCookies(userCode);
            
            const allData = [...localData, ...cookieData];
            const uniqueData = allData.filter((item, index, arr) => 
                index === arr.findIndex(t => t.timestamp === item.timestamp && t.userCode === item.userCode)
            );
            
            localStorage.setItem('d2TestData', JSON.stringify(uniqueData));
            
            const userData = uniqueData.filter(result => result.userCode === userCode);
            if (userData.length > 0) {
                const cookieName = `d2_${userCode}`;
                document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
                
                const cookiesToSave = userData.slice(-5);
                const cookieValue = encodeURIComponent(JSON.stringify(cookiesToSave));
                const expiryDate = new Date();
                expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                document.cookie = `${cookieName}=${cookieValue}; expires=${expiryDate.toUTCString()}; path=/; SameSite=Lax`;
            }
            
            alert(`✅ Daten synchronisiert! ${uniqueData.length} Einträge insgesamt gespeichert.`);
            document.getElementById('dataStatus').innerHTML = `
                <div class="success">✅ Daten erfolgreich synchronisiert! Es wurden ${uniqueData.length} eindeutige Einträge gefunden und gespeichert.</div>
            `;
        }

        function showStorageInfo() {
            const localData = JSON.parse(localStorage.getItem('d2TestData') || '[]');
            const localSize = new TextEncoder().encode(JSON.stringify(localData)).length;
            
            let cookieSize = 0;
            let cookieCount = 0;
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const trimmedCookie = cookie.trim();
                const [name, value] = trimmedCookie.split('=');
                if (name.startsWith('d2_')) {
                    cookieCount++;
                    cookieSize += new TextEncoder().encode(trimmedCookie).length;
                }
            }
            
            const info = `
                <div style="background: white; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <h4>💾 Speicher-Information:</h4>
                    <p><strong>LocalStorage:</strong> ${localData.length} Tests (${(localSize/1024).toFixed(2)} KB)</p>
                    <p><strong>Cookies:</strong> ${cookieCount} Benutzer-Cookies (${(cookieSize/1024).toFixed(2)} KB)</p>
                    <p><strong>Browser:</strong> ${navigator.userAgent}</p>
                    <p><strong>Speicher verfügbar (geschätzt):</strong> ${navigator.storage && navigator.storage.estimate ? '✅' : '❌ Info nicht verfügbar'}</p>
                </div>
            `;
            
            const dataStatusElement = document.getElementById('dataStatus');
            if (dataStatusElement) {
                dataStatusElement.innerHTML = info;
                if (navigator.storage && navigator.storage.estimate) {
                    navigator.storage.estimate().then(estimate => {
                        const storageInfoHtml = `
                            <div style="background: white; padding: 15px; border-radius: 8px; margin: 10px 0;">
                                <h4>💾 Speicher-Information:</h4>
                                <p><strong>LocalStorage:</strong> ${localData.length} Tests (${(localSize/1024).toFixed(2)} KB)</p>
                                <p><strong>Cookies:</strong> ${cookieCount} Benutzer-Cookies (${(cookieSize/1024).toFixed(2)} KB)</p>
                                <p><strong>Browser:</strong> ${navigator.userAgent}</p>
                                <p><strong>Speicher verfügbar (geschätzt):</strong> ✅ ${(estimate.usage/1024/1024).toFixed(2)} MB von ${(estimate.quota/1024/1024).toFixed(2)} MB belegt.</p>
                            </div>
                        `;
                        dataStatusElement.innerHTML = storageInfoHtml;
                    });
                }
            }
        }

        function createBackup() {
            const allLocalDataRaw = localStorage.getItem('d2TestData');
            let allLocalData = [];
            try {
                allLocalData = JSON.parse(allLocalDataRaw || '[]');
            } catch (e) {
                console.error('Error parsing localStorage for backup:', e);
                alert('Fehler beim Lesen des LocalStorage für das Backup. Backup ist möglicherweise unvollständig.');
            }

            const allUsersCookieData = {};
            
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name.startsWith('d2_')) {
                    const userCode = name.substring(3);
                    try {
                        allUsersCookieData[userCode] = JSON.parse(decodeURIComponent(value));
                    } catch (e) {
                        console.warn('Could not parse cookie data for', userCode, ':', e);
                    }
                }
            }
            
            const backup = {
                version: '1.0',
                created: new Date().toISOString(),
                localStorageContent: allLocalData,
                cookieContent: allUsersCookieData,
                totalUsersBackedUp: Object.keys(allUsersCookieData).length,
                settingsAtBackup: {
                    userCode: document.getElementById('userCode').value,
                    medication: document.getElementById('medication').value
                }
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            const isoDate = new Date().toISOString().split('T')[0];
            a.href = url;
            a.download = `d2-test-backup-${isoDate}.json`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`Vollständiges Backup erstellt: d2-test-backup-${isoDate}.json`);
        }



        // Prevent accidental page reload during test
        window.addEventListener('beforeunload', function(e) {
            if (testRunning) {
                const confirmationMessage = 'Der Test läuft noch. Möchten Sie wirklich die Seite verlassen?';
                e.returnValue = confirmationMessage;
                return confirmationMessage;
            }
        });

        // Touch event optimization
        document.addEventListener('touchmove', function(e) {
            if (testRunning) {
                e.preventDefault();
            }
        }, { passive: false });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (testRunning) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    if (!document.getElementById('nextBtn').disabled) {
                        nextRow();
                    }
                }
                if (e.key === 'Escape') {
                    if (confirm('Test wirklich abbrechen?')) {
                        resetTest();
                    }
                }
            }
            
            // Keyboard navigation for symbols
            if (testRunning && e.target.classList.contains('symbol')) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    e.target.click();
                }
            }
        });

        // Error handling
        window.addEventListener('error', function(e) {
            console.error('d2-Test Error:', e.error);
            if (testRunning) {
                const partialResult = {
                    ...calculateTotalResult(),
                    error: e.error.message,
                    incomplete: true
                };
                saveTestResult(partialResult);
            }
        });

        // Responsive design adjustments
        function adjustForScreenSize() {
            const width = window.innerWidth;
            const symbolElements = document.querySelectorAll('.symbol');
            
            if (width < 768) {
                symbolElements.forEach(el => {
                    el.style.fontSize = '1.2em';
                    el.style.padding = '4px';
                });
            } else if (width >= 768 && width < 1024) {
                symbolElements.forEach(el => {
                    el.style.fontSize = '1.4em';
                    el.style.padding = '6px';
                });
            } else {
                symbolElements.forEach(el => {
                    el.style.fontSize = '';
                    el.style.padding = '';
                });
            }
            
            const currentDisplayResult = JSON.parse(localStorage.getItem('d2TestData') || '[]')
                                        .filter(r => r.userCode === document.getElementById('userCode').value.trim())
                                        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
                                        .pop();
            if (document.getElementById('results').style.display === 'block' && currentDisplayResult) {
                drawProgressChart(currentDisplayResult);
            }
        }

        window.addEventListener('resize', adjustForScreenSize);
        window.addEventListener('orientationchange', adjustForScreenSize);

        console.log('d2-Test Application loaded successfully with Cookie support!');
        console.log('Device Info:', getDeviceInfo());

        // Debug Mode Functions
        function showCookieData() {
            const userCode = document.getElementById('userCode').value.trim();
            if (!userCode) {
                alert('Bitte geben Sie zuerst Ihren User-Code ein!');
                return;
            }
            
            const cookieData = getCookieData(`d2_${userCode}`);
            const cookieText = document.cookie;
            
            let output = `=== COOKIE-DATEN FÜR USER: ${userCode} ===\n\n`;
            output += `Vollständiger Cookie-String:\n${cookieText}\n\n`;
            output += `Geparste D2-Daten (${cookieData.length} Einträge):\n`;
            
            if (cookieData.length === 0) {
                output += 'Keine D2-Testdaten in Cookies gefunden.\n';
            } else {
                cookieData.forEach((entry, index) => {
                    output += `\nEintrag ${index + 1}:\n`;
                    output += `- Timestamp: ${entry.timestamp}\n`;
                    output += `- Medikation: ${entry.medication}\n`;
                    output += `- Genauigkeit: ${entry.overallAccuracy}%\n`;
                    output += `- Korrekte Markierungen: ${entry.totalCorrect}\n`;
                    output += `- Input-Methode: ${entry.inputMethod || 'nicht verfügbar'}\n`;
                    if (entry.deviceInfo) {
                        output += `- Gerät: ${entry.deviceInfo.userAgent}\n`;
                    }
                });
            }
            
            // Create modal dialog with unique ID
            const modalId = 'cookieModal_' + Date.now();
            const modal = document.createElement('div');
            modal.id = modalId;
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; padding: 30px; border-radius: 10px;
                max-width: 80%; max-height: 80%; overflow: auto;
                font-family: monospace; font-size: 12px;
            `;
            
            content.innerHTML = `
                <h3>🍪 Cookie-Daten für ${userCode}</h3>
                <textarea readonly id="cookieOutput_${modalId}" style="width: 100%; height: 400px; font-family: monospace; font-size: 11px;">${output}</textarea>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="closeModal('${modalId}')" class="btn">Schließen</button>
                    <button onclick="copyToClipboard('cookieOutput_${modalId}')" class="btn btn-primary">In Zwischenablage kopieren</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }

        function copyToClipboard(textareaId) {
            const textarea = document.getElementById(textareaId);
            if (textarea) {
                textarea.select();
                textarea.setSelectionRange(0, 99999); // For mobile devices
                
                // Try modern clipboard API first
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(textarea.value).then(() => {
                        alert('📋 In Zwischenablage kopiert!');
                    }).catch(err => {
                        console.error('Clipboard API failed:', err);
                        fallbackCopy(textarea);
                    });
                } else {
                    // Fallback for older browsers
                    fallbackCopy(textarea);
                }
            }
        }

        function fallbackCopy(textarea) {
            try {
                document.execCommand('copy');
                alert('📋 In Zwischenablage kopiert!');
            } catch (err) {
                console.error('Copy failed:', err);
                alert('⚠️ Kopieren fehlgeschlagen. Bitte manuell markieren und kopieren.');
            }
        }

        function downloadCookieData() {
            const userCode = document.getElementById('userCode').value.trim();
            if (!userCode) {
                alert('Bitte geben Sie zuerst Ihren User-Code ein!');
                return;
            }
            
            try {
                const cookieData = getCookieData(`d2_${userCode}`);
                const allCookies = document.cookie;
                
                const debugData = {
                    userCode: userCode,
                    timestamp: new Date().toISOString(),
                    fullCookieString: allCookies,
                    parsedD2Data: cookieData,
                    localStorage: JSON.parse(localStorage.getItem('d2TestData') || '[]'),
                    debugInfo: {
                        url: window.location.href,
                        userAgent: navigator.userAgent,
                        cookieEnabled: navigator.cookieEnabled,
                        storageQuota: 'unknown',
                        downloadPath: 'Browser-Standard Downloads-Ordner'
                    }
                };
                
                const jsonString = JSON.stringify(debugData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                // Erstelle Download-Link mit verbesserter Kompatibilität
                const link = document.createElement('a');
                link.href = url;
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                link.download = `d2-debug-${userCode}-${timestamp}.json`;
                
                // Stelle sicher, dass der Download funktioniert
                link.style.display = 'none';
                document.body.appendChild(link);
                
                // Trigger download
                link.click();
                
                // Cleanup
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 100);
                
                // Benutzerfreundliche Meldung
                alert(`📥 Debug-Daten für "${userCode}" werden in Ihren Downloads-Ordner heruntergeladen!\n\nDateiname: d2-debug-${userCode}-${timestamp}.json\n\nHinweis: Die Datei wird automatisch in Ihrem Standard-Downloads-Ordner gespeichert.`);
                
            } catch (error) {
                console.error('Download-Fehler:', error);
                alert('❌ Fehler beim Herunterladen der Debug-Daten. Bitte versuchen Sie es erneut oder prüfen Sie die Browser-Konsole.');
            }
        }

        function showAllStorageData() {
            const localData = JSON.parse(localStorage.getItem('d2TestData') || '[]');
            const allCookies = document.cookie;
            
            let output = '=== ALLE SPEICHERDATEN ===\n\n';
            output += `LocalStorage (${localData.length} Einträge):\n`;
            localData.forEach((entry, index) => {
                output += `${index + 1}. ${entry.userCode} - ${entry.timestamp} - ${entry.overallAccuracy}%\n`;
            });
            
            output += '\n=== ALLE COOKIES ===\n';
            output += allCookies || 'Keine Cookies gefunden';
            
            output += '\n\n=== D2-SPEZIFISCHE COOKIES ===\n';
            const d2Cookies = document.cookie.split(';').filter(cookie => cookie.trim().startsWith('d2_'));
            if (d2Cookies.length === 0) {
                output += 'Keine D2-Cookies gefunden\n';
            } else {
                d2Cookies.forEach(cookie => {
                    const [name, value] = cookie.trim().split('=');
                    output += `${name}: ${value ? value.substring(0, 100) + '...' : 'leer'}\n`;
                });
            }
            
            // Create modal with unique ID
            const modalId = 'storageModal_' + Date.now();
            const modal = document.createElement('div');
            modal.id = modalId;
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; padding: 30px; border-radius: 10px;
                max-width: 90%; max-height: 80%; overflow: auto;
            `;
            
            content.innerHTML = `
                <h3>📊 Alle Speicherdaten</h3>
                <textarea readonly style="width: 100%; height: 400px; font-family: monospace; font-size: 11px;">${output}</textarea>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="closeModal('${modalId}')" class="btn">Schließen</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        function clearAllDebugData() {
            if (!confirm('⚠️ Wirklich ALLE Debug-Daten löschen?\n\nDies löscht:\n- Alle LocalStorage-Daten\n- Alle D2-Cookies\n\nDieser Vorgang kann nicht rückgängig gemacht werden!')) {
                return;
            }
            
            // Clear localStorage
            localStorage.removeItem('d2TestData');
            
            // Clear all D2 cookies
            const d2Cookies = document.cookie.split(';').filter(cookie => cookie.trim().startsWith('d2_'));
            d2Cookies.forEach(cookie => {
                const cookieName = cookie.trim().split('=')[0];
                document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;
            });
            
            alert('🗑️ Alle Debug-Daten wurden gelöscht!');
            
            // Reload page to reflect changes
            if (confirm('Seite neu laden, um Änderungen zu sehen?')) {
                window.location.reload();
            }
        }

    </script>
</body>
</html>